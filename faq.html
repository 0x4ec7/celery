<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Frequently Asked Questions &mdash; Celery v0.9.5 (unstable) documentation</title>
    <link rel="stylesheet" href="static/adctheme.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.9.5 (unstable)',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="Celery v0.9.5 (unstable) documentation" href="index.html" />
    <link rel="next" title="API Reference" href="reference/index.html" />
    <link rel="prev" title="Tutorial: Creating a click counter using carrot and celery" href="tutorials/clickcounter.html" /> 
  </head>
  <body>
<div id="docstitle">
	<p>Celery v0.9.5 (unstable) documentation</p>
</div>
<div id="header">
	<div id="title"><h1>Frequently Asked Questions</h1></div>
	<ul id="headerButtons">
		<li id="toc_button"><div class="headerButton"><a href="#">Table of Contents</a></div></li>
		<li id="page_buttons">
			<div class="headerButton"><a href="genindex.html" title="General Index" accesskey="I">index</a></div>
			<div class="headerButton"><a href="modindex.html" title="Global Module Index" accesskey="M">modules</a></div>
			<div class="headerButton"><a href="reference/index.html" title="API Reference" accesskey="N">next</a></div>
			<div class="headerButton"><a href="tutorials/clickcounter.html" title="Tutorial: Creating a click counter using carrot and celery" accesskey="P">previous</a></div>
		</li>
	</ul>
</div>

<div id="sphinxsidebar">
  <div class="sphinxsidebarwrapper">
	<ul><li class="toctree-l1"><a href="index.html">Main Page</a></li></ul>
	<ul class="current">
<li class="toctree-l1"><a class="reference external" href="introduction.html">celery - Distributed Task Queue</a></li>
<li class="toctree-l1"><a class="reference external" href="configuration.html">Configuration and defaults</a></li>
<li class="toctree-l1"><a class="reference external" href="userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference external" href="tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="current reference external" href="">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference external" href="#misconceptions">Misconceptions</a></li>
<li class="toctree-l2"><a class="reference external" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference external" href="#brokers">Brokers</a></li>
<li class="toctree-l2"><a class="reference external" href="#features">Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="internals/index.html">Internals</a></li>
<li class="toctree-l1"><a class="reference external" href="changelog.html">Change history</a></li>
<li class="toctree-l1"><a class="reference external" href="links.html">Interesting Links</a></li>
</ul>

      <h3>This Page</h3>
      <ul class="this-page-menu">
        <li><a href="sources/faq.txt"
               rel="nofollow">Show Source</a></li>
      </ul>
    <div id="searchbox" style="display: none">
      
        <form class="search" action="search.html" method="get">
			<div class="search-wrapper">
			<span class="search-left"></span>
			<input class="prettysearch" type="text" name="q" size="18" />
			<span class="search-right">&nbsp;</span>
			</div>
          <input type="submit" value="Search" class="searchbutton" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
        <p class="searchtip" style="font-size: 90%">
        Enter search terms or a module, class or function name.
        </p>
    </div>
    <script type="text/javascript">$('#searchbox').show(0);</script>
  </div>
</div>



    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="frequently-asked-questions">
<h1>Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="misconceptions">
<h2>Misconceptions<a class="headerlink" href="#misconceptions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="is-celery-dependent-on-pickle">
<h3>Is celery dependent on pickle?<a class="headerlink" href="#is-celery-dependent-on-pickle" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> No.</p>
<p>Celery can support any serialization scheme and has support for JSON/YAML and
Pickle by default. You can even send one task using pickle, and another one
with JSON seamlessly, this is because every task is associated with a
content-type. The default serialization scheme is pickle because it&#8217;s the most
used, and it has support for sending complex objects as task arguments.</p>
<p>You can set a global default serializer, the default serializer for a
particular Task, and even what serializer to use when sending a single task
instance.</p>
</div>
<div class="section" id="is-celery-for-django-only">
<h3>Is celery for Django only?<a class="headerlink" href="#is-celery-for-django-only" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> No.</p>
<p>While django itself is a dependency, you can still use all of celerys features
outside of a django project.</p>
</div>
<div class="section" id="do-i-have-to-use-amqp-rabbitmq">
<h3>Do I have to use AMQP/RabbitMQ?<a class="headerlink" href="#do-i-have-to-use-amqp-rabbitmq" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: No.</p>
<p>You can also use Redis or an SQL database, for instructions see <a class="reference external" href="http://ask.github.com/celery/tutorials/otherqueues.html">Using other
queues</a>.</p>
<p>Redis or a database won&#8217;t meet up to the standards
of an AMQP broker. If you have strict reliability requirements you are
encouraged to use RabbitMQ or another AMQP broker. Redis/database also uses
pulling, so they are likely to consume more resources. However, if you for
some reason is not able to use AMQP, feel free to use these alternatives.
They will probably work fine for most use cases, and note that the above
points are not specific to celery; If using Redis/database as a queue worked
fine for you before, it probably will now. And you can always upgrade later.</p>
</div>
<div class="section" id="is-celery-multi-lingual">
<h3>Is celery multi-lingual?<a class="headerlink" href="#is-celery-multi-lingual" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Yes.</p>
<p>celeryd is an implementation of celery in python. If the language has an AMQP
client, there shouldn&#8217;t be much work to create a worker in your language.
A celery worker is just a program connecting to the broker to consume
messages. There&#8217;s no other communication involved.</p>
<p>Also, there&#8217;s another way to be language indepedent, and that is to use REST
tasks, instead of your tasks being functions, they&#8217;re URLs. With this
information you can even create simple web servers that enable preloading of
code. For more information about REST tasks see: <a class="reference external" href="http://ask.github.com/celery/userguide/remote-tasks.html">User Guide: Remote Tasks</a>.</p>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mysql-is-throwing-deadlock-errors-what-can-i-do">
<h3>MySQL is throwing deadlock errors, what can I do?<a class="headerlink" href="#mysql-is-throwing-deadlock-errors-what-can-i-do" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> MySQL has default isolation level set to <tt class="docutils literal"><span class="pre">REPEATABLE-READ</span></tt>,
if you don&#8217;t really need that, set it to <tt class="docutils literal"><span class="pre">READ-COMMITTED</span></tt>.
You can do that by adding the following to your <tt class="docutils literal"><span class="pre">my.cnf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">transaction</span><span class="o">-</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">READ</span><span class="o">-</span><span class="n">COMMITTED</span>
</pre></div>
</div>
<p>For more information about InnoDBs transaction model see <a class="reference external" href="http://dev.mysql.com/doc/refman/5.1/en/innodb-transaction-model.html">MySQL - The InnoDB
Transaction Model and Locking</a> in the MySQL user manual.</p>
<p>(Thanks to Honza Kral and Anton Tsigularov for this solution)</p>
</div>
<div class="section" id="celeryd-is-not-doing-anything-just-hanging">
<h3>celeryd is not doing anything, just hanging<a class="headerlink" href="#celeryd-is-not-doing-anything-just-hanging" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>Answer:</strong> See <a class="reference internal" href="#mysql-is-throwing-deadlock-errors-what-can-i-do">MySQL is throwing deadlock errors, what can I do?</a>.</dt>
<dd>or <cite>Why is Task.delay/apply* just hanging?</cite>.</dd>
</dl>
</div>
<div class="section" id="why-is-task-delay-apply-celeryd-just-hanging">
<h3>Why is Task.delay/apply*/celeryd just hanging?<a class="headerlink" href="#why-is-task-delay-apply-celeryd-just-hanging" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> There is a bug in some AMQP clients that will make it hang if
it&#8217;s not able to authenticate the current user, the password doesn&#8217;t match or
the user does not have access to the virtual host specified. Be sure to check
your broker logs (for RabbitMQ that is <tt class="docutils literal"><span class="pre">/var/log/rabbitmq/rabbit.log</span></tt> on
most systems), it usually contains a message describing the reason.</p>
</div>
<div class="section" id="why-won-t-celeryd-run-on-freebsd">
<h3>Why won&#8217;t celeryd run on FreeBSD?<a class="headerlink" href="#why-won-t-celeryd-run-on-freebsd" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> multiprocessing.Pool requires a working POSIX semaphore
implementation which isn&#8217;t enabled in FreeBSD by default. You have to enable
POSIX semaphores in the kernel and manually recompile multiprocessing.</p>
<p>Luckily, Viktor Petersson has written a tutorial to get you started with
Celery on FreeBSD here:
<a class="reference external" href="http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/">http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/</a></p>
</div>
<div class="section" id="i-m-having-integrityerror-duplicate-key-errors-why">
<h3>I&#8217;m having <tt class="docutils literal"><span class="pre">IntegrityError:</span> <span class="pre">Duplicate</span> <span class="pre">Key</span></tt> errors. Why?<a class="headerlink" href="#i-m-having-integrityerror-duplicate-key-errors-why" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> See <a class="reference internal" href="#mysql-is-throwing-deadlock-errors-what-can-i-do">MySQL is throwing deadlock errors, what can I do?</a>.
Thanks to howsthedotcom.</p>
</div>
<div class="section" id="why-isn-t-my-tasks-processed">
<h3>Why isn&#8217;t my tasks processed?<a class="headerlink" href="#why-isn-t-my-tasks-processed" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> With RabbitMQ you can see how many consumers are currently
receiving tasks by running the following command:</p>
<div class="highlight-python"><pre>$ rabbitmqctl list_queues -p &lt;myvhost&gt; name messages consumers
Listing queues ...
celery     2891    2</pre>
</div>
<p>This shows that there&#8217;s 2891 messages waiting to be processed in the task
queue, and there are two consumers processing them.</p>
<p>One reason that the queue is never emptied could be that you have a stale
celery process taking the messages hostage. This could happen if celeryd
wasn&#8217;t properly shut down.</p>
<p>When a message is recieved by a worker the broker waits for it to be
acknowledged before marking the message as processed. The broker will not
re-send that message to another consumer until the consumer is shutdown
properly.</p>
<p>If you hit this problem you have to kill all workers manually and restart
them:</p>
<div class="highlight-python"><pre>ps auxww | grep celeryd | awk '{print $2}' | xargs kill</pre>
</div>
<p>You might have to wait a while until all workers has finished the work they&#8217;re
doing, if it&#8217;s still hanging after a long time you can kill them by force
with:</p>
<div class="highlight-python"><pre>ps auxww | grep celeryd | awk '{print $2}' | xargs kill -9</pre>
</div>
</div>
<div class="section" id="why-won-t-my-task-run">
<h3>Why won&#8217;t my Task run?<a class="headerlink" href="#why-won-t-my-task-run" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Did you register the task in the applications <tt class="docutils literal"><span class="pre">tasks.py</span></tt> module?
(or in some other module Django loads by default, like <tt class="docutils literal"><span class="pre">models.py</span></tt>?).
Also there might be syntax errors preventing the tasks module being imported.</p>
<p>You can find out if celery is able to run the task by executing the
task manually:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">MyPeriodicTask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyPeriodicTask</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>Watch celeryds logfile to see if it&#8217;s able to find the task, or if some
other error is happening.</p>
</div>
<div class="section" id="why-won-t-my-periodic-task-run">
<h3>Why won&#8217;t my Periodic Task run?<a class="headerlink" href="#why-won-t-my-periodic-task-run" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> See <a class="reference internal" href="#why-won-t-my-task-run">Why won&#8217;t my Task run?</a>.</p>
</div>
<div class="section" id="how-do-i-discard-all-waiting-tasks">
<h3>How do I discard all waiting tasks?<a class="headerlink" href="#how-do-i-discard-all-waiting-tasks" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Use <tt class="docutils literal"><span class="pre">celery.task.discard_all()</span></tt>, like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">discard_all</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">discard_all</span><span class="p">()</span>
<span class="go">1753</span>
</pre></div>
</div>
<p>The number <tt class="docutils literal"><span class="pre">1753</span></tt> is the number of messages deleted.</p>
<p>You can also start celeryd with the <tt class="docutils literal"><span class="pre">--discard</span></tt> argument which will
accomplish the same thing.</p>
</div>
<div class="section" id="i-ve-discarded-messages-but-there-are-still-messages-left-in-the-queue">
<h3>I&#8217;ve discarded messages, but there are still messages left in the queue?<a class="headerlink" href="#i-ve-discarded-messages-but-there-are-still-messages-left-in-the-queue" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Tasks are acknowledged (removed from the queue) as soon
as they are actually executed. After the worker has received a task, it will
take some time until it is actually executed, especially if there are a lot
of tasks already waiting for execution. Messages that are not acknowledged are
hold on to by the worker until it closes the connection to the broker (AMQP
server). When that connection is closed (e.g because the worker was stopped)
the tasks will be re-sent by the broker to the next available worker (or the
same worker when it has been restarted), so to properly purge the queue of
waiting tasks you have to stop all the workers, and then discard the tasks
using <tt class="docutils literal"><span class="pre">discard_all</span></tt>.</p>
</div>
</div>
<div class="section" id="brokers">
<h2>Brokers<a class="headerlink" href="#brokers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="can-i-use-celery-with-activemq-stomp">
<h3>Can I use celery with ActiveMQ/STOMP?<a class="headerlink" href="#can-i-use-celery-with-activemq-stomp" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. But this is somewhat experimental for now.
It is certainly working ok for me in a test configuration, but it has not
been tested in production like RabbitMQ. If you have any problems with
using STOMP and celery, please report the bugs to the issue tracker:</p>
<blockquote>
<a class="reference external" href="http://github.com/ask/celery/issues/">http://github.com/ask/celery/issues/</a></blockquote>
<p>First you have to use the <tt class="docutils literal"><span class="pre">master</span></tt> branch of <tt class="docutils literal"><span class="pre">celery</span></tt>:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/ask/celery.git
$ cd celery
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>Then you need to install the <tt class="docutils literal"><span class="pre">stompbackend</span></tt> branch of <tt class="docutils literal"><span class="pre">carrot</span></tt>:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/ask/carrot.git
$ cd carrot
$ git checkout stompbackend
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>And my fork of <tt class="docutils literal"><span class="pre">python-stomp</span></tt> which adds non-blocking support:</p>
<div class="highlight-python"><pre>$ hg clone http://bitbucket.org/asksol/python-stomp/
$ cd python-stomp
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>In this example we will use a queue called <tt class="docutils literal"><span class="pre">celery</span></tt> which we created in
the ActiveMQ web admin interface.</p>
<p><strong>Note</strong>: For ActiveMQ the queue name has to have <tt class="docutils literal"><span class="pre">&quot;/queue/&quot;</span></tt> prepended to
it. i.e. the queue <tt class="docutils literal"><span class="pre">celery</span></tt> becomes <tt class="docutils literal"><span class="pre">/queue/celery</span></tt>.</p>
<p>Since a STOMP queue is a single named entity and it doesn&#8217;t have the
routing capabilities of AMQP you need to set both the <tt class="docutils literal"><span class="pre">queue</span></tt>, and
<tt class="docutils literal"><span class="pre">exchange</span></tt> settings to your queue name. This is a minor inconvenience since
carrot needs to maintain the same interface for both AMQP and STOMP (obviously
the one with the most capabilities won).</p>
<p>Use the following specific settings in your <tt class="docutils literal"><span class="pre">settings.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Makes python-stomp the default backend for carrot.</span>
<span class="n">CARROT_BACKEND</span> <span class="o">=</span> <span class="s">&quot;stomp&quot;</span>

<span class="c"># STOMP hostname and port settings.</span>
<span class="n">BROKER_HOST</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
<span class="n">BROKER_PORT</span> <span class="o">=</span> <span class="mi">61613</span>

<span class="c"># The queue name to use (both queue and exchange must be set to the</span>
<span class="c"># same queue name when using STOMP)</span>
<span class="n">CELERY_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&quot;/queue/celery&quot;</span>
<span class="n">CELERY_DEFAULT_EXCHANGE</span> <span class="o">=</span> <span class="s">&quot;/queue/celery&quot;</span>

<span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;/queue/celery&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;exchange&quot;</span><span class="p">:</span> <span class="s">&quot;/queue/celery&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you can go on reading the tutorial in the README, ignoring any AMQP
specific options.</p>
</div>
<div class="section" id="which-features-are-not-supported-when-using-stomp">
<h3>Which features are not supported when using STOMP?<a class="headerlink" href="#which-features-are-not-supported-when-using-stomp" title="Permalink to this headline">¶</a></h3>
<p>This is a (possible incomplete) list of features not available when
using the STOMP backend:</p>
<ul class="simple">
<li>routing keys</li>
<li>exchange types (direct, topic, headers, etc)</li>
<li>immediate</li>
<li>mandatory</li>
</ul>
</div>
</div>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="can-i-send-some-tasks-to-only-some-servers">
<h3>Can I send some tasks to only some servers?<a class="headerlink" href="#can-i-send-some-tasks-to-only-some-servers" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Yes. You can route tasks to an arbitrary server using AMQP,
and a worker can bind to as many queues as it wants.</p>
<p>Say you have two servers, <tt class="docutils literal"><span class="pre">x</span></tt>, and <tt class="docutils literal"><span class="pre">y</span></tt> that handles regular tasks,
and one server <tt class="docutils literal"><span class="pre">z</span></tt>, that only handles feed related tasks, you can use this
configuration:</p>
<ul class="simple">
<li>Servers <tt class="docutils literal"><span class="pre">x</span></tt> and <tt class="docutils literal"><span class="pre">y</span></tt>: settings.py:</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&quot;regular_tasks&quot;</span>
<span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;regular_tasks&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;task.#&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">CELERY_DEFAULT_EXCHANGE</span> <span class="o">=</span> <span class="s">&quot;tasks&quot;</span>
<span class="n">CELERY_DEFAULT_EXCHANGE_TYPE</span> <span class="o">=</span> <span class="s">&quot;topic&quot;</span>
<span class="n">CELERY_DEFAULT_ROUTING_KEY</span> <span class="o">=</span> <span class="s">&quot;task.regular&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li>Server <tt class="docutils literal"><span class="pre">z</span></tt>: settings.py:</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&quot;feed_tasks&quot;</span>
<span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;feed_tasks&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;feed.#&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">CELERY_DEFAULT_EXCHANGE</span> <span class="o">=</span> <span class="s">&quot;tasks&quot;</span>
<span class="n">CELERY_DEFAULT_ROUTING_KEY</span> <span class="o">=</span> <span class="s">&quot;task.regular&quot;</span>
<span class="n">CELERY_DEFAULT_EXCHANGE_TYPE</span> <span class="o">=</span> <span class="s">&quot;topic&quot;</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">CELERY_QUEUES</span></tt> is a map of queue names and their exchange/type/binding_key,
if you don&#8217;t set exchange or exchange type, they will be taken from the
<tt class="docutils literal"><span class="pre">CELERY_DEFAULT_EXCHANGE</span></tt>/<tt class="docutils literal"><span class="pre">CELERY_DEFAULT_EXCHANGE_TYPE</span></tt> settings.</p>
<p>Now to make a Task run on the <tt class="docutils literal"><span class="pre">z</span></tt> server you need to set its
<tt class="docutils literal"><span class="pre">routing_key</span></tt> attribute so it starts with the words <tt class="docutils literal"><span class="pre">&quot;task.feed.&quot;</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">feedaggregator.models</span> <span class="kn">import</span> <span class="n">Feed</span>
<span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">routing_key</span><span class="o">=</span><span class="s">&quot;feed.importer&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">import_feed</span><span class="p">(</span><span class="n">feed_url</span><span class="p">):</span>
    <span class="n">Feed</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">import_feed</span><span class="p">(</span><span class="n">feed_url</span><span class="p">)</span>
</pre></div>
</div>
<p>or if subclassing the <tt class="docutils literal"><span class="pre">Task</span></tt> class directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FeedImportTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">routing_key</span> <span class="o">=</span> <span class="s">&quot;feed.importer&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed_url</span><span class="p">):</span>
        <span class="n">Feed</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">import_feed</span><span class="p">(</span><span class="n">feed_url</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also override this using the <tt class="docutils literal"><span class="pre">routing_key</span></tt> argument to
<tt class="xref docutils literal"><span class="pre">celery.task.apply_async()</span></tt>:</p>
<blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">RefreshFeedTask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">RefreshFeedTask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;http://cnn.com/rss&quot;</span><span class="p">],</span>
<span class="gp">... </span>                            <span class="n">routing_key</span><span class="o">=</span><span class="s">&quot;feed.importer&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want, you can even have your feed processing worker handle regular
tasks as well, maybe in times when there&#8217;s a lot of work to do.
Just add a new queue to server <tt class="docutils literal"><span class="pre">z</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">CELERY_QUEUES</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;feed_tasks&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;feed.#&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">&quot;regular_tasks&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;task.#&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</blockquote>
<p>Since the default exchange is <tt class="docutils literal"><span class="pre">tasks</span></tt>, they will both use the same
exchange.</p>
<p>If you have another queue but on another exchange you want to add,
just specify a custom exchange and exchange type:</p>
<div class="highlight-python"><pre>CELERY_QUEUES = {
        "feed_tasks": {
            "binding_key": "feed.#",
        },
        "regular_tasks": {
            "binding_key": "task.#",
        }
        "image_tasks": {
            "binding_key": "image.compress",
            "exchange": "mediatasks",
            "exchange_type": "direct",
        },
    }</pre>
</div>
<p>Easy? No? If you&#8217;re confused about these terms, you should read up on
AMQP and RabbitMQ. It might be hard to grok the concepts of
queues, exchanges and routing/binding keys at first, but it&#8217;s all very simple,
I assure you.</p>
</div>
<div class="section" id="can-i-use-celery-without-django">
<h3>Can I use celery without Django?<a class="headerlink" href="#can-i-use-celery-without-django" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Yes.</p>
<p>Celery uses something called loaders to read/setup configuration, import
modules that registers tasks and to decide what happens when a task is
executed. Currently there are two loaders, the default loader and the Django
loader. If you want to use celery without a Django project, you either have to
use the default loader, or write a loader of your own.</p>
<p>The rest of this answer describes how to use the default loader.</p>
<p>First of all, installation. You need to get the development version of
celery from github:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/ask/celery.git
$ cd celery
# python setup.py install # as root</pre>
</div>
<p>While it is possible to use celery from outside of Django, we still need
Django itself to run, this is to use the ORM and cache-framework, etc.
Duplicating these features would be time consuming and mostly pointless, so
we decided that having a dependency on Django itself was a good thing.
Install Django using your favorite install tool, <tt class="docutils literal"><span class="pre">easy_install</span></tt>, <tt class="docutils literal"><span class="pre">pip</span></tt>, or
whatever:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># easy_install django # as root</span>
</pre></div>
</div>
<p>You need a configuration file named <tt class="docutils literal"><span class="pre">celeryconfig.py</span></tt>, either in the
directory you run <tt class="docutils literal"><span class="pre">celeryd</span></tt> in, or in a Python library path where it is
able to find it. The configuration file can contain any of the settings
described in <tt class="xref docutils literal"><span class="pre">celery.conf</span></tt>, and in additional if you&#8217;re using the
database backend you have to configure the database. Here is an example
configuration using the database backend with MySQL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Broker configuration</span>
<span class="n">BROKER_HOST</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
<span class="n">BROKER_PORT</span> <span class="o">=</span> <span class="s">&quot;5672&quot;</span>
<span class="n">BROKER_VHOST</span> <span class="o">=</span> <span class="s">&quot;celery&quot;</span>
<span class="n">BROKER_USER</span> <span class="o">=</span> <span class="s">&quot;celery&quot;</span>
<span class="n">BROKER_PASSWORD</span> <span class="o">=</span> <span class="s">&quot;celerysecret&quot;</span>
<span class="n">CARROT_BACKEND</span><span class="o">=</span><span class="s">&quot;amqp&quot;</span>

<span class="c"># Using the database backend.</span>
<span class="n">CELERY_BACKEND</span> <span class="o">=</span> <span class="s">&quot;database&quot;</span>
<span class="n">DATABASE_ENGINE</span> <span class="o">=</span> <span class="s">&quot;mysql&quot;</span> <span class="c"># see Django docs for a description of these.</span>
<span class="n">DATABASE_NAME</span> <span class="o">=</span> <span class="s">&quot;mydb&quot;</span>
<span class="n">DATABASE_HOST</span> <span class="o">=</span> <span class="s">&quot;mydb.example.org&quot;</span>
<span class="n">DATABASE_USER</span> <span class="o">=</span> <span class="s">&quot;myuser&quot;</span>
<span class="n">DATABASE_PASSWORD</span> <span class="o">=</span> <span class="s">&quot;mysecret&quot;</span>

<span class="c"># Number of processes that processes tasks simultaneously.</span>
<span class="n">CELERYD_CONCURRENCY</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c"># Modules to import when celeryd starts.</span>
<span class="c"># This must import every module where you register tasks so celeryd</span>
<span class="c"># is able to find and run them.</span>
<span class="n">CELERY_IMPORTS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;mytaskmodule1&quot;</span><span class="p">,</span> <span class="s">&quot;mytaskmodule2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now with this configuration file in the current directory you have to
run <tt class="docutils literal"><span class="pre">celeryinit</span></tt> to create the database tables:</p>
<div class="highlight-python"><pre>$ celeryinit</pre>
</div>
<p>Then you should be able to successfully run <tt class="docutils literal"><span class="pre">celeryd</span></tt>:</p>
<div class="highlight-python"><pre>$ celeryd --loglevel=INFO</pre>
</div>
<p>and send a task from a python shell (note that it must be able to import
<tt class="docutils literal"><span class="pre">celeryconfig.py</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.task.builtins</span> <span class="kn">import</span> <span class="n">PingTask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">PingTask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">&#39;pong&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="the-celery-test-suite-is-failing">
<h3>The celery test-suite is failing<a class="headerlink" href="#the-celery-test-suite-is-failing" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: You&#8217;re running tests from your own Django applicaiton, and celerys
tests are failing and celerys tests are failing in that context?
If so, read on for a trick, if not please report the test failure to our issue
tracker at GitHub.</p>
<blockquote>
<a class="reference external" href="http://github.com/ask/celery/issues/">http://github.com/ask/celery/issues/</a></blockquote>
<p>That Django is running tests for all applications in <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt>
is a pet peeve of mine. You should use a test runner that either</p>
<ol class="arabic simple">
<li>Explicitly lists the apps you want to run tests for, or</li>
<li>make a test runner that skips tests for apps you don&#8217;t want to run.</li>
</ol>
<p>For example this test runner that celery is using:</p>
<blockquote>
<a class="reference external" href="http://bit.ly/NVKep">http://bit.ly/NVKep</a></blockquote>
<p>To use this add the following to your settings.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEST_RUNNER</span> <span class="o">=</span> <span class="s">&quot;celery.tests.runners.run_tests&quot;</span>
<span class="n">TEST_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&quot;app1&quot;</span><span class="p">,</span>
    <span class="s">&quot;app2&quot;</span><span class="p">,</span>
    <span class="s">&quot;app3&quot;</span><span class="p">,</span>
    <span class="s">&quot;app4&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If you just want to skip celery you could use:</p>
<div class="highlight-python"><pre>INSTALLED_APPS = (.....)
TEST_RUNNER = "celery.tests.runners.run_tests"
TEST_APPS = filter(lambda k: k != "celery", INSTALLED_APPS)</pre>
</div>
</div>
<div class="section" id="can-i-change-the-interval-of-a-periodic-task-at-runtime">
<h3>Can I change the interval of a periodic task at runtime?<a class="headerlink" href="#can-i-change-the-interval-of-a-periodic-task-at-runtime" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. You can override <tt class="docutils literal"><span class="pre">PeriodicTask.is_due</span></tt> or turn
<tt class="docutils literal"><span class="pre">PeriodicTask.run_every</span></tt> into a property:</p>
<div class="highlight-python"><pre>class MyPeriodic(PeriodicTask):

    def run(self):
        # ...

    @property
    def run_every(self):
        return get_interval_from_database(...)</pre>
</div>
</div>
</div>
</div>


          </div> 
        </div>
      </div>
    <div class="footer">
    <p>
      &copy; Copyright 2009, Ask Solem.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
	</p>
    </div>
      <div class="clearer"></div>
    </div>
	<div id="breadcrumbs">
		<a href="index.html">Celery v0.9.5 (unstable) documentation</a>
		</ul>
	</div>
  </body>
</html>