
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Frequently Asked Questions &mdash; Celery v1.1.3 (unstable) documentation</title>
    <link rel="stylesheet" href="static/classy.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.1.3 (unstable)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="Celery v1.1.3 (unstable) documentation" href="index.html" />
    <link rel="next" title="API Reference" href="reference/index.html" />
    <link rel="prev" title="Tutorial: Creating a click counter using carrot and celery" href="tutorials/clickcounter.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference/index.html" title="API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorials/clickcounter.html" title="Tutorial: Creating a click counter using carrot and celery"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Celery v1.1.3 (unstable) documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="frequently-asked-questions">
<h1>Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference external" href="#general" id="id1">General</a><ul>
<li><a class="reference external" href="#what-kinds-of-things-should-i-use-celery-for" id="id2">What kinds of things should I use celery for?</a></li>
</ul>
</li>
<li><a class="reference external" href="#misconceptions" id="id3">Misconceptions</a><ul>
<li><a class="reference external" href="#is-celery-dependent-on-pickle" id="id4">Is celery dependent on pickle?</a></li>
<li><a class="reference external" href="#is-celery-for-django-only" id="id5">Is celery for Django only?</a></li>
<li><a class="reference external" href="#do-i-have-to-use-amqp-rabbitmq" id="id6">Do I have to use AMQP/RabbitMQ?</a></li>
<li><a class="reference external" href="#is-celery-multi-lingual" id="id7">Is celery multi-lingual?</a></li>
</ul>
</li>
<li><a class="reference external" href="#troubleshooting" id="id8">Troubleshooting</a><ul>
<li><a class="reference external" href="#mysql-is-throwing-deadlock-errors-what-can-i-do" id="id9">MySQL is throwing deadlock errors, what can I do?</a></li>
<li><a class="reference external" href="#celeryd-is-not-doing-anything-just-hanging" id="id10">celeryd is not doing anything, just hanging</a></li>
<li><a class="reference external" href="#why-is-task-delay-apply-celeryd-just-hanging" id="id11">Why is Task.delay/apply*/celeryd just hanging?</a></li>
<li><a class="reference external" href="#why-won-t-celeryd-run-on-freebsd" id="id12">Why won&#8217;t celeryd run on FreeBSD?</a></li>
<li><a class="reference external" href="#i-m-having-integrityerror-duplicate-key-errors-why" id="id13">I&#8217;m having <tt class="docutils literal"><span class="pre">IntegrityError:</span> <span class="pre">Duplicate</span> <span class="pre">Key</span></tt> errors. Why?</a></li>
<li><a class="reference external" href="#why-aren-t-my-tasks-processed" id="id14">Why aren&#8217;t my tasks processed?</a></li>
<li><a class="reference external" href="#why-won-t-my-task-run" id="id15">Why won&#8217;t my Task run?</a></li>
<li><a class="reference external" href="#why-won-t-my-periodic-task-run" id="id16">Why won&#8217;t my Periodic Task run?</a></li>
<li><a class="reference external" href="#how-do-i-discard-all-waiting-tasks" id="id17">How do I discard all waiting tasks?</a></li>
<li><a class="reference external" href="#i-ve-discarded-messages-but-there-are-still-messages-left-in-the-queue" id="id18">I&#8217;ve discarded messages, but there are still messages left in the queue?</a></li>
<li><a class="reference external" href="#windows-the-b-beat-option-to-celeryd-doesn-t-work" id="id19">Windows: The <tt class="docutils literal"><span class="pre">-B</span></tt> / <tt class="docutils literal"><span class="pre">--beat</span></tt> option to celeryd doesn&#8217;t work?</a></li>
</ul>
</li>
<li><a class="reference external" href="#tasks" id="id20">Tasks</a><ul>
<li><a class="reference external" href="#how-can-i-reuse-the-same-connection-when-applying-tasks" id="id21">How can I reuse the same connection when applying tasks?</a></li>
<li><a class="reference external" href="#can-i-execute-a-task-by-name" id="id22">Can I execute a task by name?</a></li>
</ul>
</li>
<li><a class="reference external" href="#results" id="id23">Results</a><ul>
<li><a class="reference external" href="#how-do-i-get-the-result-of-a-task-if-i-have-the-id-that-points-there" id="id24">How do I get the result of a task if I have the ID that points there?</a></li>
</ul>
</li>
<li><a class="reference external" href="#brokers" id="id25">Brokers</a><ul>
<li><a class="reference external" href="#why-is-rabbitmq-crashing" id="id26">Why is RabbitMQ crashing?</a></li>
<li><a class="reference external" href="#can-i-use-celery-with-activemq-stomp" id="id27">Can I use celery with ActiveMQ/STOMP?</a></li>
<li><a class="reference external" href="#what-features-are-not-supported-when-using-stomp" id="id28">What features are not supported when using STOMP?</a></li>
</ul>
</li>
<li><a class="reference external" href="#features" id="id29">Features</a><ul>
<li><a class="reference external" href="#how-can-i-run-a-task-once-another-task-has-finished" id="id30">How can I run a task once another task has finished?</a></li>
<li><a class="reference external" href="#can-i-cancel-the-execution-of-a-task" id="id31">Can I cancel the execution of a task?</a></li>
<li><a class="reference external" href="#why-aren-t-my-remote-control-commands-received-by-all-workers" id="id32">Why aren&#8217;t my remote control commands received by all workers?</a></li>
<li><a class="reference external" href="#can-i-send-some-tasks-to-only-some-servers" id="id33">Can I send some tasks to only some servers?</a></li>
<li><a class="reference external" href="#can-i-change-the-interval-of-a-periodic-task-at-runtime" id="id34">Can I change the interval of a periodic task at runtime?</a></li>
<li><a class="reference external" href="#does-celery-support-task-priorities" id="id35">Does celery support task priorities?</a></li>
<li><a class="reference external" href="#should-i-use-retry-or-acks-late" id="id36">Should I use retry or acks_late?</a></li>
<li><a class="reference external" href="#module-celery.task.base" id="id37">Can I schedule tasks to execute at a specific time?</a></li>
<li><a class="reference external" href="#how-do-i-shut-down-celeryd-safely" id="id38">How do I shut down <tt class="docutils literal"><span class="pre">celeryd</span></tt> safely?</a></li>
<li><a class="reference external" href="#how-do-i-run-celeryd-in-the-background-on-platform" id="id39">How do I run celeryd in the background on [platform]?</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general">
<h2><a class="toc-backref" href="#id1">General</a><a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-kinds-of-things-should-i-use-celery-for">
<h3><a class="toc-backref" href="#id2">What kinds of things should I use celery for?</a><a class="headerlink" href="#what-kinds-of-things-should-i-use-celery-for" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> <a class="reference external" href="http://decafbad.com/blog/2008/07/04/queue-everything-and-delight-everyone">Queue everything and delight everyone</a> is a good article
describing why you would use a queue in a web context.</p>
<p>These are some common use cases:</p>
<ul class="simple">
<li>Running something in the background. For example, to finish the web request
as soon as possible, then update the users page incrementally.
This gives the user the impression of good performane and &#8220;snappiness&#8221;, even
though the real work might actually take some time.</li>
<li>Running something after the web request has finished.</li>
<li>Making sure something is done, by executing it asynchronously and using
retries.</li>
<li>Scheduling periodic work.</li>
</ul>
<p>And to some degree:</p>
<ul class="simple">
<li>Distributed computing.</li>
<li>Parallel execution.</li>
</ul>
</div>
</div>
<div class="section" id="misconceptions">
<h2><a class="toc-backref" href="#id3">Misconceptions</a><a class="headerlink" href="#misconceptions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="is-celery-dependent-on-pickle">
<h3><a class="toc-backref" href="#id4">Is celery dependent on pickle?</a><a class="headerlink" href="#is-celery-dependent-on-pickle" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> No.</p>
<p>Celery can support any serialization scheme and has support for JSON/YAML and
Pickle by default. You can even send one task using pickle, and another one
with JSON seamlessly, this is because every task is associated with a
content-type. The default serialization scheme is pickle because it&#8217;s the most
used, and it has support for sending complex objects as task arguments.</p>
<p>You can set a global default serializer, the default serializer for a
particular Task, or even what serializer to use when sending a single task
instance.</p>
</div>
<div class="section" id="is-celery-for-django-only">
<h3><a class="toc-backref" href="#id5">Is celery for Django only?</a><a class="headerlink" href="#is-celery-for-django-only" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> No.</p>
<p>Celery does not depend on Django anymore. To use Celery with Django you have
to use the <a class="reference external" href="http://pypi.python.org/pypi/django-celery">django-celery</a> package.</p>
</div>
<div class="section" id="do-i-have-to-use-amqp-rabbitmq">
<h3><a class="toc-backref" href="#id6">Do I have to use AMQP/RabbitMQ?</a><a class="headerlink" href="#do-i-have-to-use-amqp-rabbitmq" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: No.</p>
<p>You can also use Redis or an SQL database, see <a class="reference external" href="http://ask.github.com/celery/tutorials/otherqueues.html">Using other
queues</a>.</p>
<p>Redis or a database won&#8217;t perform as well as
an AMQP broker. If you have strict reliability requirements you are
encouraged to use RabbitMQ or another AMQP broker. Redis/database also use
polling, so they are likely to consume more resources. However, if you for
some reason are not able to use AMQP, feel free to use these alternatives.
They will probably work fine for most use cases, and note that the above
points are not specific to celery; If using Redis/database as a queue worked
fine for you before, it probably will now. You can always upgrade later
if you need to.</p>
</div>
<div class="section" id="is-celery-multi-lingual">
<h3><a class="toc-backref" href="#id7">Is celery multi-lingual?</a><a class="headerlink" href="#is-celery-multi-lingual" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Yes.</p>
<p>celeryd is an implementation of celery in python. If the language has an AMQP
client, there shouldn&#8217;t be much work to create a worker in your language.
A celery worker is just a program connecting to the broker to consume
messages. There&#8217;s no other communication involved.</p>
<p>Also, there&#8217;s another way to be language indepedent, and that is to use REST
tasks, instead of your tasks being functions, they&#8217;re URLs. With this
information you can even create simple web servers that enable preloading of
code. See: <a class="reference external" href="http://ask.github.com/celery/userguide/remote-tasks.html">User Guide: Remote Tasks</a>.</p>
</div>
</div>
<div class="section" id="troubleshooting">
<h2><a class="toc-backref" href="#id8">Troubleshooting</a><a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mysql-is-throwing-deadlock-errors-what-can-i-do">
<h3><a class="toc-backref" href="#id9">MySQL is throwing deadlock errors, what can I do?</a><a class="headerlink" href="#mysql-is-throwing-deadlock-errors-what-can-i-do" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> MySQL has default isolation level set to <tt class="docutils literal"><span class="pre">REPEATABLE-READ</span></tt>,
if you don&#8217;t really need that, set it to <tt class="docutils literal"><span class="pre">READ-COMMITTED</span></tt>.
You can do that by adding the following to your <tt class="docutils literal"><span class="pre">my.cnf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">transaction</span><span class="o">-</span><span class="n">isolation</span> <span class="o">=</span> <span class="n">READ</span><span class="o">-</span><span class="n">COMMITTED</span>
</pre></div>
</div>
<p>For more information about InnoDBs transaction model see <a class="reference external" href="http://dev.mysql.com/doc/refman/5.1/en/innodb-transaction-model.html">MySQL - The InnoDB
Transaction Model and Locking</a> in the MySQL user manual.</p>
<p>(Thanks to Honza Kral and Anton Tsigularov for this solution)</p>
</div>
<div class="section" id="celeryd-is-not-doing-anything-just-hanging">
<h3><a class="toc-backref" href="#id10">celeryd is not doing anything, just hanging</a><a class="headerlink" href="#celeryd-is-not-doing-anything-just-hanging" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>Answer:</strong> See <a class="reference external" href="#mysql-is-throwing-deadlock-errors-what-can-i-do">MySQL is throwing deadlock errors, what can I do?</a>.</dt>
<dd>or <cite>Why is Task.delay/apply* just hanging?</cite>.</dd>
</dl>
</div>
<div class="section" id="why-is-task-delay-apply-celeryd-just-hanging">
<h3><a class="toc-backref" href="#id11">Why is Task.delay/apply*/celeryd just hanging?</a><a class="headerlink" href="#why-is-task-delay-apply-celeryd-just-hanging" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> There is a bug in some AMQP clients that will make it hang if
it&#8217;s not able to authenticate the current user, the password doesn&#8217;t match or
the user does not have access to the virtual host specified. Be sure to check
your broker logs (for RabbitMQ that is <tt class="docutils literal"><span class="pre">/var/log/rabbitmq/rabbit.log</span></tt> on
most systems), it usually contains a message describing the reason.</p>
</div>
<div class="section" id="why-won-t-celeryd-run-on-freebsd">
<h3><a class="toc-backref" href="#id12">Why won&#8217;t celeryd run on FreeBSD?</a><a class="headerlink" href="#why-won-t-celeryd-run-on-freebsd" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> multiprocessing.Pool requires a working POSIX semaphore
implementation which isn&#8217;t enabled in FreeBSD by default. You have to enable
POSIX semaphores in the kernel and manually recompile multiprocessing.</p>
<p>Luckily, Viktor Petersson has written a tutorial to get you started with
Celery on FreeBSD here:
<a class="reference external" href="http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/">http://www.playingwithwire.com/2009/10/how-to-get-celeryd-to-work-on-freebsd/</a></p>
</div>
<div class="section" id="i-m-having-integrityerror-duplicate-key-errors-why">
<h3><a class="toc-backref" href="#id13">I&#8217;m having <tt class="docutils literal"><span class="pre">IntegrityError:</span> <span class="pre">Duplicate</span> <span class="pre">Key</span></tt> errors. Why?</a><a class="headerlink" href="#i-m-having-integrityerror-duplicate-key-errors-why" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> See <a class="reference external" href="#mysql-is-throwing-deadlock-errors-what-can-i-do">MySQL is throwing deadlock errors, what can I do?</a>.
Thanks to howsthedotcom.</p>
</div>
<div class="section" id="why-aren-t-my-tasks-processed">
<h3><a class="toc-backref" href="#id14">Why aren&#8217;t my tasks processed?</a><a class="headerlink" href="#why-aren-t-my-tasks-processed" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> With RabbitMQ you can see how many consumers are currently
receiving tasks by running the following command:</p>
<div class="highlight-python"><pre>$ rabbitmqctl list_queues -p &lt;myvhost&gt; name messages consumers
Listing queues ...
celery     2891    2</pre>
</div>
<p>This shows that there&#8217;s 2891 messages waiting to be processed in the task
queue, and there are two consumers processing them.</p>
<p>One reason that the queue is never emptied could be that you have a stale
celery process taking the messages hostage. This could happen if celeryd
wasn&#8217;t properly shut down.</p>
<p>When a message is recieved by a worker the broker waits for it to be
acknowledged before marking the message as processed. The broker will not
re-send that message to another consumer until the consumer is shut down
properly.</p>
<p>If you hit this problem you have to kill all workers manually and restart
them:</p>
<div class="highlight-python"><pre>ps auxww | grep celeryd | awk '{print $2}' | xargs kill</pre>
</div>
<p>You might have to wait a while until all workers have finished the work they&#8217;re
doing. If it&#8217;s still hanging after a long time you can kill them by force
with:</p>
<div class="highlight-python"><pre>ps auxww | grep celeryd | awk '{print $2}' | xargs kill -9</pre>
</div>
</div>
<div class="section" id="why-won-t-my-task-run">
<h3><a class="toc-backref" href="#id15">Why won&#8217;t my Task run?</a><a class="headerlink" href="#why-won-t-my-task-run" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> There might be syntax errors preventing the tasks module being imported.</p>
<p>You can find out if celery is able to run the task by executing the
task manually:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">MyPeriodicTask</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyPeriodicTask</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>Watch celeryds logfile to see if it&#8217;s able to find the task, or if some
other error is happening.</p>
</div>
<div class="section" id="why-won-t-my-periodic-task-run">
<h3><a class="toc-backref" href="#id16">Why won&#8217;t my Periodic Task run?</a><a class="headerlink" href="#why-won-t-my-periodic-task-run" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> See <a class="reference external" href="#why-won-t-my-task-run">Why won&#8217;t my Task run?</a>.</p>
</div>
<div class="section" id="how-do-i-discard-all-waiting-tasks">
<h3><a class="toc-backref" href="#id17">How do I discard all waiting tasks?</a><a class="headerlink" href="#how-do-i-discard-all-waiting-tasks" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Use <tt class="docutils literal"><span class="pre">celery.task.discard_all()</span></tt>, like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">discard_all</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">discard_all</span><span class="p">()</span>
<span class="go">1753</span>
</pre></div>
</div>
<p>The number <tt class="docutils literal"><span class="pre">1753</span></tt> is the number of messages deleted.</p>
<p>You can also start celeryd with the <tt class="docutils literal"><span class="pre">--discard</span></tt> argument which will
accomplish the same thing.</p>
</div>
<div class="section" id="i-ve-discarded-messages-but-there-are-still-messages-left-in-the-queue">
<h3><a class="toc-backref" href="#id18">I&#8217;ve discarded messages, but there are still messages left in the queue?</a><a class="headerlink" href="#i-ve-discarded-messages-but-there-are-still-messages-left-in-the-queue" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Tasks are acknowledged (removed from the queue) as soon
as they are actually executed. After the worker has received a task, it will
take some time until it is actually executed, especially if there are a lot
of tasks already waiting for execution. Messages that are not acknowledged are
hold on to by the worker until it closes the connection to the broker (AMQP
server). When that connection is closed (e.g because the worker was stopped)
the tasks will be re-sent by the broker to the next available worker (or the
same worker when it has been restarted), so to properly purge the queue of
waiting tasks you have to stop all the workers, and then discard the tasks
using <tt class="docutils literal"><span class="pre">discard_all</span></tt>.</p>
</div>
<div class="section" id="windows-the-b-beat-option-to-celeryd-doesn-t-work">
<h3><a class="toc-backref" href="#id19">Windows: The <tt class="docutils literal"><span class="pre">-B</span></tt> / <tt class="docutils literal"><span class="pre">--beat</span></tt> option to celeryd doesn&#8217;t work?</a><a class="headerlink" href="#windows-the-b-beat-option-to-celeryd-doesn-t-work" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: That&#8217;s right. Run <tt class="docutils literal"><span class="pre">celerybeat</span></tt> and <tt class="docutils literal"><span class="pre">celeryd</span></tt> as separate
services instead.</p>
</div>
</div>
<div class="section" id="tasks">
<h2><a class="toc-backref" href="#id20">Tasks</a><a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-can-i-reuse-the-same-connection-when-applying-tasks">
<h3><a class="toc-backref" href="#id21">How can I reuse the same connection when applying tasks?</a><a class="headerlink" href="#how-can-i-reuse-the-same-connection-when-applying-tasks" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: See <a class="reference internal" href="userguide/executing.html"><em>Executing Tasks</em></a>.</p>
</div>
<div class="section" id="can-i-execute-a-task-by-name">
<h3><a class="toc-backref" href="#id22">Can I execute a task by name?</a><a class="headerlink" href="#can-i-execute-a-task-by-name" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. Use <a class="reference internal" href="reference/celery.execute.html#celery.execute.send_task" title="celery.execute.send_task"><tt class="xref py py-func docutils literal"><span class="pre">celery.execute.send_task()</span></tt></a>.
You can also execute a task by name from any language
that has an AMQP client.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.execute</span> <span class="kn">import</span> <span class="n">send_task</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">send_task</span><span class="p">(</span><span class="s">&quot;tasks.add&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>
<span class="go">&lt;AsyncResult: 373550e8-b9a0-4666-bc61-ace01fa4f91d&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="results">
<h2><a class="toc-backref" href="#id23">Results</a><a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-do-i-get-the-result-of-a-task-if-i-have-the-id-that-points-there">
<h3><a class="toc-backref" href="#id24">How do I get the result of a task if I have the ID that points there?</a><a class="headerlink" href="#how-do-i-get-the-result-of-a-task-if-i-have-the-id-that-points-there" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Use <tt class="docutils literal"><span class="pre">Task.AsyncResult</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">MyTask</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>This will give you a <a class="reference internal" href="reference/celery.result.html#celery.result.BaseAsyncResult" title="celery.result.BaseAsyncResult"><tt class="xref py py-class docutils literal"><span class="pre">celery.result.BaseAsyncResult</span></tt></a> instance
using the tasks current result backend.</p>
<p>If you need to specify a custom result backend you should use
<a class="reference internal" href="reference/celery.result.html#celery.result.BaseAsyncResult" title="celery.result.BaseAsyncResult"><tt class="xref py py-class docutils literal"><span class="pre">celery.result.BaseAsyncResult</span></tt></a> directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">BaseAsyncResult</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">BaseAsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">backend</span><span class="o">=...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="brokers">
<h2><a class="toc-backref" href="#id25">Brokers</a><a class="headerlink" href="#brokers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="why-is-rabbitmq-crashing">
<h3><a class="toc-backref" href="#id26">Why is RabbitMQ crashing?</a><a class="headerlink" href="#why-is-rabbitmq-crashing" title="Permalink to this headline">¶</a></h3>
<p>RabbitMQ will crash if it runs out of memory. This will be fixed in a
future release of RabbitMQ. please refer to the RabbitMQ FAQ:
<a class="reference external" href="http://www.rabbitmq.com/faq.html#node-runs-out-of-memory">http://www.rabbitmq.com/faq.html#node-runs-out-of-memory</a></p>
<p>Some common Celery misconfigurations can crash RabbitMQ:</p>
<ul class="simple">
<li>Events.</li>
</ul>
<p>Running <tt class="docutils literal"><span class="pre">celeryd</span></tt> with the <tt class="docutils literal"><span class="pre">-E</span></tt>/<tt class="docutils literal"><span class="pre">--events</span></tt> option will send messages
for events happening inside of the worker. If these event messages
are not consumed, you will eventually run out of memory.</p>
<p>Events should only be enabled if you have an active monitor consuming them.</p>
<ul class="simple">
<li>AMQP backend results.</li>
</ul>
<p>When running with the AMQP result backend, every task result will be sent
as a message. If you don&#8217;t collect these results, they will build up and
RabbitMQ will eventually run out of memory.</p>
<p>If you don&#8217;t use the results for a task, make sure you set the
<tt class="docutils literal"><span class="pre">ignore_result</span></tt> option:</p>
<p>Results can also be disabled globally using the <tt class="docutils literal"><span class="pre">CELERY_IGNORE_RESULT</span></tt>
setting.</p>
</div>
<div class="section" id="can-i-use-celery-with-activemq-stomp">
<h3><a class="toc-backref" href="#id27">Can I use celery with ActiveMQ/STOMP?</a><a class="headerlink" href="#can-i-use-celery-with-activemq-stomp" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes, but this is somewhat experimental for now.
It is working ok in a test configuration, but it has not
been tested in production like RabbitMQ has. If you have any problems with
using STOMP and celery, please report the bugs to the issue tracker:</p>
<blockquote>
<a class="reference external" href="http://github.com/ask/celery/issues/">http://github.com/ask/celery/issues/</a></blockquote>
<p>First you have to use the <tt class="docutils literal"><span class="pre">master</span></tt> branch of <tt class="docutils literal"><span class="pre">celery</span></tt>:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/ask/celery.git
$ cd celery
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>Then you need to install the <tt class="docutils literal"><span class="pre">stompbackend</span></tt> branch of <tt class="docutils literal"><span class="pre">carrot</span></tt>:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/ask/carrot.git
$ cd carrot
$ git checkout stompbackend
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>And my fork of <tt class="docutils literal"><span class="pre">python-stomp</span></tt> which adds non-blocking support:</p>
<div class="highlight-python"><pre>$ hg clone http://bitbucket.org/asksol/python-stomp/
$ cd python-stomp
$ sudo python setup.py install
$ cd ..</pre>
</div>
<p>In this example we will use a queue called <tt class="docutils literal"><span class="pre">celery</span></tt> which we created in
the ActiveMQ web admin interface.</p>
<p><strong>Note</strong>: For ActiveMQ the queue name has to have <tt class="docutils literal"><span class="pre">&quot;/queue/&quot;</span></tt> prepended to
it. i.e. the queue <tt class="docutils literal"><span class="pre">celery</span></tt> becomes <tt class="docutils literal"><span class="pre">/queue/celery</span></tt>.</p>
<p>Since a STOMP queue is a single named entity and it doesn&#8217;t have the
routing capabilities of AMQP you need to set both the <tt class="docutils literal"><span class="pre">queue</span></tt>, and
<tt class="docutils literal"><span class="pre">exchange</span></tt> settings to your queue name. This is a minor inconvenience since
carrot needs to maintain the same interface for both AMQP and STOMP (obviously
the one with the most capabilities won).</p>
<p>Use the following specific settings in your <tt class="docutils literal"><span class="pre">settings.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Makes python-stomp the default backend for carrot.</span>
<span class="n">CARROT_BACKEND</span> <span class="o">=</span> <span class="s">&quot;stomp&quot;</span>

<span class="c"># STOMP hostname and port settings.</span>
<span class="n">BROKER_HOST</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
<span class="n">BROKER_PORT</span> <span class="o">=</span> <span class="mi">61613</span>

<span class="c"># The queue name to use (both queue and exchange must be set to the</span>
<span class="c"># same queue name when using STOMP)</span>
<span class="n">CELERY_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&quot;/queue/celery&quot;</span>
<span class="n">CELERY_DEFAULT_EXCHANGE</span> <span class="o">=</span> <span class="s">&quot;/queue/celery&quot;</span>

<span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;/queue/celery&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;exchange&quot;</span><span class="p">:</span> <span class="s">&quot;/queue/celery&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you can go on reading the tutorial in the README, ignoring any AMQP
specific options.</p>
</div>
<div class="section" id="what-features-are-not-supported-when-using-stomp">
<h3><a class="toc-backref" href="#id28">What features are not supported when using STOMP?</a><a class="headerlink" href="#what-features-are-not-supported-when-using-stomp" title="Permalink to this headline">¶</a></h3>
<p>This is a (possible incomplete) list of features not available when
using the STOMP backend:</p>
<blockquote>
<ul class="simple">
<li>routing keys</li>
<li>exchange types (direct, topic, headers, etc)</li>
<li>immediate</li>
<li>mandatory</li>
</ul>
</blockquote>
</div>
</div>
<div class="section" id="features">
<h2><a class="toc-backref" href="#id29">Features</a><a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-can-i-run-a-task-once-another-task-has-finished">
<h3><a class="toc-backref" href="#id30">How can I run a task once another task has finished?</a><a class="headerlink" href="#how-can-i-run-a-task-once-another-task-has-finished" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: You can safely launch a task inside a task.
Also, a common pattern is to use callback tasks:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="n">subtask</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">log_result</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;log_result got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">))</span>
</pre></div>
</div>
<p>Invocation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">log_result</span><span class="o">.</span><span class="n">subtask</span><span class="p">())</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="userguide/tasksets.html"><em>Sets of tasks, Subtasks and Callbacks</em></a> for more information.</p>
</div>
<div class="section" id="can-i-cancel-the-execution-of-a-task">
<h3><a class="toc-backref" href="#id31">Can I cancel the execution of a task?</a><a class="headerlink" href="#can-i-cancel-the-execution-of-a-task" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. Use <tt class="docutils literal"><span class="pre">result.revoke</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
</pre></div>
</div>
<p>or if you only have the task id:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.task.control</span> <span class="kn">import</span> <span class="n">revoke</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">revoke</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="why-aren-t-my-remote-control-commands-received-by-all-workers">
<h3><a class="toc-backref" href="#id32">Why aren&#8217;t my remote control commands received by all workers?</a><a class="headerlink" href="#why-aren-t-my-remote-control-commands-received-by-all-workers" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: To receive broadcast remote control commands, every <tt class="docutils literal"><span class="pre">celeryd</span></tt>
uses its hostname to create a unique queue name to listen to,
so if you have more than one worker with the same hostname, the
control commands will be recieved in round-robin between them.</p>
<p>To work around this you can explicitly set the hostname for every worker
using the <tt class="docutils literal"><span class="pre">--hostname</span></tt> argument to <tt class="docutils literal"><span class="pre">celeryd</span></tt>:</p>
<div class="highlight-python"><pre>$ celeryd --hostname=$(hostname).1
$ celeryd --hostname=$(hostname).2</pre>
</div>
<p>etc, etc.</p>
</div>
<div class="section" id="can-i-send-some-tasks-to-only-some-servers">
<h3><a class="toc-backref" href="#id33">Can I send some tasks to only some servers?</a><a class="headerlink" href="#can-i-send-some-tasks-to-only-some-servers" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer:</strong> Yes. You can route tasks to an arbitrary server using AMQP,
and a worker can bind to as many queues as it wants.</p>
<p>See <a class="reference internal" href="userguide/routing.html"><em>Routing Tasks</em></a> for more information.</p>
</div>
<div class="section" id="can-i-change-the-interval-of-a-periodic-task-at-runtime">
<h3><a class="toc-backref" href="#id34">Can I change the interval of a periodic task at runtime?</a><a class="headerlink" href="#can-i-change-the-interval-of-a-periodic-task-at-runtime" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. You can override <tt class="docutils literal"><span class="pre">PeriodicTask.is_due</span></tt> or turn
<tt class="docutils literal"><span class="pre">PeriodicTask.run_every</span></tt> into a property:</p>
<div class="highlight-python"><pre>class MyPeriodic(PeriodicTask):

    def run(self):
        # ...

    @property
    def run_every(self):
        return get_interval_from_database(...)</pre>
</div>
</div>
<div class="section" id="does-celery-support-task-priorities">
<h3><a class="toc-backref" href="#id35">Does celery support task priorities?</a><a class="headerlink" href="#does-celery-support-task-priorities" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: No. In theory, yes, as AMQP supports priorities. However
RabbitMQ doesn&#8217;t implement them yet.</p>
<p>The usual way to prioritize work in celery, is to route high priority tasks
to different servers. In the real world this may actually work better than per message
priorities. You can use this in combination with rate limiting to achieve a
highly performant system.</p>
</div>
<div class="section" id="should-i-use-retry-or-acks-late">
<h3><a class="toc-backref" href="#id36">Should I use retry or acks_late?</a><a class="headerlink" href="#should-i-use-retry-or-acks-late" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Depends. It&#8217;s not necessarily one or the other, you may want
to use both.</p>
<p><tt class="docutils literal"><span class="pre">Task.retry</span></tt> is used to retry tasks, notably for expected errors that
is catchable with the <tt class="docutils literal"><span class="pre">try:</span></tt> block. The AMQP transaction is not used
for these errors: <strong>if the task raises an exception it is still acked!</strong>.</p>
<p>The <tt class="docutils literal"><span class="pre">acks_late</span></tt> setting would be used when you need the task to be
executed again if the worker (for some reason) crashes mid-execution.
It&#8217;s important to note that the worker is not known to crash, and if
it does it is usually an unrecoverable error that requires human
intervention (bug in the worker, or task code).</p>
<p>In an ideal world you could safely retry any task that has failed, but
this is rarely the case. Imagine the following task:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_upload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">):</span>
    <span class="c"># Increment a file count stored in a database</span>
    <span class="n">increment_file_counter</span><span class="p">()</span>
    <span class="n">add_file_metadata_to_db</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">)</span>
    <span class="n">copy_file_to_destination</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>If this crashed in the middle of copying the file to its destination
the world would contain incomplete state. This is not a critical
scenario of course, but you can probably imagine something far more
sinister. So for ease of programming we have less reliability;
It&#8217;s a good default, users who require it and know what they
are doing can still enable acks_late (and in the future hopefully
use manual acknowledgement)</p>
<p>In addition <tt class="docutils literal"><span class="pre">Task.retry</span></tt> has features not available in AMQP
transactions: delay between retries, max retries, etc.</p>
<p>So use retry for Python errors, and if your task is reentrant
combine that with <tt class="docutils literal"><span class="pre">acks_late</span></tt> if that level of reliability
is required.</p>
</div>
<div class="section" id="module-celery.task.base">
<span id="can-i-schedule-tasks-to-execute-at-a-specific-time"></span><h3><a class="toc-backref" href="#id37">Can I schedule tasks to execute at a specific time?</a><a class="headerlink" href="#module-celery.task.base" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Yes. You can use the <tt class="docutils literal"><span class="pre">eta</span></tt> argument of <a class="reference internal" href="reference/celery.task.base.html#celery.task.base.Task.apply_async" title="celery.task.base.Task.apply_async"><tt class="xref py py-meth docutils literal"><span class="pre">Task.apply_async()</span></tt></a>.</p>
<p>Or to schedule a periodic task at a specific time, use the
<a class="reference internal" href="reference/celery.task.schedules.html#celery.task.schedules.crontab" title="celery.task.schedules.crontab"><tt class="xref py py-class docutils literal"><span class="pre">celery.task.schedules.crontab</span></tt></a> schedule behavior:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.task.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
<span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">periodic_task</span>

<span class="nd">@periodic_task</span><span class="p">(</span><span class="n">run_every</span><span class="o">=</span><span class="n">crontab</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">day_of_week</span><span class="o">=</span><span class="s">&quot;mon&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">every_monday_morning</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;This is run every monday morning at 7:30&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-shut-down-celeryd-safely">
<h3><a class="toc-backref" href="#id38">How do I shut down <tt class="docutils literal"><span class="pre">celeryd</span></tt> safely?</a><a class="headerlink" href="#how-do-i-shut-down-celeryd-safely" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Use the <tt class="docutils literal"><span class="pre">TERM</span></tt> signal, and celery will finish all currently
executing jobs and shut down as soon as possible. No tasks should be lost.</p>
<p>You should never stop <tt class="docutils literal"><span class="pre">celeryd</span></tt> with the <tt class="docutils literal"><span class="pre">KILL</span></tt> signal (<tt class="docutils literal"><span class="pre">-9</span></tt>),
unless you&#8217;ve tried <tt class="docutils literal"><span class="pre">TERM</span></tt> a few times and waited a few minutes to let it
get a chance to shut down. As if you do tasks may be terminated mid-execution,
and they will not be re-run unless you have the <tt class="docutils literal"><span class="pre">acks_late</span></tt> option set.
(<tt class="docutils literal"><span class="pre">Task.acks_late</span></tt> / <tt class="docutils literal"><span class="pre">CELERY_ACKS_LATE</span></tt>).</p>
</div>
<div class="section" id="how-do-i-run-celeryd-in-the-background-on-platform">
<h3><a class="toc-backref" href="#id39">How do I run celeryd in the background on [platform]?</a><a class="headerlink" href="#how-do-i-run-celeryd-in-the-background-on-platform" title="Permalink to this headline">¶</a></h3>
<p><strong>Answer</strong>: Please see <a class="reference internal" href="cookbook/daemonizing.html"><em>Running celeryd as a daemon</em></a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference/index.html" title="API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorials/clickcounter.html" title="Tutorial: Creating a click counter using carrot and celery"
             >previous</a> |</li>
        <li><a href="index.html">Celery v1.1.3 (unstable) documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, Ask Solem.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0b2.
    </div>
  </body>
</html>