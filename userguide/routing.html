
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Routing Tasks &mdash; Celery v1.1.1 (unstable) documentation</title>
    <link rel="stylesheet" href="../static/classy.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.1 (unstable)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Celery v1.1.1 (unstable) documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Configuration and defaults" href="../configuration.html" />
    <link rel="prev" title="HTTP Callback Tasks (Webhooks)" href="remote-tasks.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../configuration.html" title="Configuration and defaults"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="remote-tasks.html" title="HTTP Callback Tasks (Webhooks)"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Celery v1.1.1 (unstable) documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">User Guide</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="routing-tasks">
<h1>Routing Tasks<a class="headerlink" href="#routing-tasks" title="Permalink to this headline">¶</a></h1>
<p><strong>NOTE</strong> This document refers to functionality only available in brokers
using AMQP. Other brokers may implement some functionality, see their
respective documenation for more information, or contact the <a class="reference external" href="http://groups.google.com/group/celery-users">mailinglist</a>.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference external" href="#amqp-primer" id="id1">AMQP Primer</a><ul>
<li><a class="reference external" href="#messages" id="id2">Messages</a></li>
<li><a class="reference external" href="#producers-consumers-and-brokers" id="id3">Producers, consumers and brokers</a></li>
<li><a class="reference external" href="#exchanges-queues-and-routing-keys" id="id4">Exchanges, queues and routing keys.</a></li>
<li><a class="reference external" href="#exchange-types" id="id5">Exchange types</a><ul>
<li><a class="reference external" href="#direct-exchanges" id="id6">Direct exchanges</a></li>
<li><a class="reference external" href="#topic-exchanges" id="id7">Topic exchanges</a></li>
</ul>
</li>
<li><a class="reference external" href="#related-api-commands" id="id8">Related API commands</a><ul>
<li><a class="reference external" href="#exchange-declare-exchange-name-type-passive-durable-auto-delete-internal" id="id9">exchange.declare(exchange_name, type, passive, durable, auto_delete, internal)</a></li>
<li><a class="reference external" href="#queue-declare-queue-name-passive-durable-exclusive-auto-delete" id="id10">queue.declare(queue_name, passive, durable, exclusive, auto_delete)</a></li>
<li><a class="reference external" href="#queue-bind-queue-name-exchange-name-routing-key" id="id11">queue.bind(queue_name, exchange_name, routing_key)</a></li>
<li><a class="reference external" href="#queue-delete-name-if-unused-if-empty" id="id12">queue.delete(name, if_unused, if_empty)</a></li>
<li><a class="reference external" href="#exchange-delete-name-if-unused" id="id13">exchange.delete(name, if_unused)</a></li>
</ul>
</li>
<li><a class="reference external" href="#hands-on-with-the-api" id="id14">Hands-on with the API</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="amqp-primer">
<h2><a class="toc-backref" href="#id1">AMQP Primer</a><a class="headerlink" href="#amqp-primer" title="Permalink to this headline">¶</a></h2>
<div class="section" id="messages">
<h3><a class="toc-backref" href="#id2">Messages</a><a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h3>
<p>A message consists of headers and a body. Celery uses headers to store
the content type of the message and its content encoding. In Celery the
content type is usually the serialization format used to serialize the
message, and the body contains the name of the task to execute, the
task id (UUID), the arguments to execute it with and some additional
metadata - like the number of retries and its ETA (if any).</p>
<p>This is an example task message represented as a Python dictionary:</p>
<div class="highlight-python"><pre>{"task": "myapp.tasks.add",
 "id":
 "args": [4, 4],
 "kwargs": {}}</pre>
</div>
</div>
<div class="section" id="producers-consumers-and-brokers">
<h3><a class="toc-backref" href="#id3">Producers, consumers and brokers</a><a class="headerlink" href="#producers-consumers-and-brokers" title="Permalink to this headline">¶</a></h3>
<p>The client sending messages is typically called a <em>publisher</em>, or
a <em>producer</em>, while the entity receiving messages is called
a <em>consumer</em>.</p>
<p>The <em>broker</em> is the message server, routing messages from producers
to consumers.</p>
<p>You are likely to see these terms used a lot in AMQP related material.</p>
</div>
<div class="section" id="exchanges-queues-and-routing-keys">
<h3><a class="toc-backref" href="#id4">Exchanges, queues and routing keys.</a><a class="headerlink" href="#exchanges-queues-and-routing-keys" title="Permalink to this headline">¶</a></h3>
<p>TODO Mindblowing one-line simple explanation here. TODO</p>
<ol class="arabic simple">
<li>Messages are sent to exchanges.</li>
<li>An exchange routes messages to one or more queues. Several exchange types
exists, providing different ways to do routing.</li>
<li>The message waits in the queue until someone consumes from it.</li>
<li>The message is deleted from the queue when it has been acknowledged.</li>
</ol>
<p>The steps required to send and receive messages are:</p>
<ol class="arabic simple">
<li>Create an exchange</li>
<li>Create a queue</li>
<li>Bind the queue to the exchange.</li>
</ol>
<p>Celery automatically creates the entities necessary for the queues in
<tt class="docutils literal"><span class="pre">CELERY_QUEUES</span></tt> to work (unless the queue&#8217;s <tt class="docutils literal"><span class="pre">auto_declare</span></tt> setting
is set)</p>
<p>Here&#8217;s an example queue configuration with three queues;
One for video, one for images and one default queue for everything else:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;exchange&quot;</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">},</span>
    <span class="s">&quot;videos&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;exchange&quot;</span><span class="p">:</span> <span class="s">&quot;media&quot;</span><span class="p">,</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;media.video&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">&quot;images&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;exchange&quot;</span><span class="p">:</span> <span class="s">&quot;media&quot;</span><span class="p">,</span>
        <span class="s">&quot;binding_key&quot;</span><span class="p">:</span> <span class="s">&quot;media.image&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">CELERY_DEFAULT_QUEUE</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span>
<span class="n">CELERY_DEFAULT_EXCHANGE_TYPE</span> <span class="o">=</span> <span class="s">&quot;direct&quot;</span>
<span class="n">CELERY_DEFAULT_ROUTING_KEY</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: In Celery the <tt class="docutils literal"><span class="pre">routing_key</span></tt> is the key used to send the message,
while <tt class="docutils literal"><span class="pre">binding_key</span></tt> is the key the queue is bound with. In the AMQP API
they are both referred to as a routing key.</p>
</div>
<div class="section" id="exchange-types">
<h3><a class="toc-backref" href="#id5">Exchange types</a><a class="headerlink" href="#exchange-types" title="Permalink to this headline">¶</a></h3>
<p>The exchange type defines how the messages are routed through the exchange.
The exchange types defined in the standard are <tt class="docutils literal"><span class="pre">direct</span></tt>, <tt class="docutils literal"><span class="pre">topic</span></tt>,
<tt class="docutils literal"><span class="pre">fanout</span></tt> and <tt class="docutils literal"><span class="pre">headers</span></tt>. Also non-standard exchange types are available
as plugins to RabbitMQ, like the <a class="reference external" href="http://github.com/squaremo/rabbitmq-lvc-plugin">last-value-cache plug-in</a> by Michael
Bridgen.</p>
<div class="section" id="direct-exchanges">
<h4><a class="toc-backref" href="#id6">Direct exchanges</a><a class="headerlink" href="#direct-exchanges" title="Permalink to this headline">¶</a></h4>
<p>Direct exchanges match by exact routing keys, so a queue bound with
the routing key <tt class="docutils literal"><span class="pre">video</span></tt> only receives messages with the same routing key.</p>
</div>
<div class="section" id="topic-exchanges">
<h4><a class="toc-backref" href="#id7">Topic exchanges</a><a class="headerlink" href="#topic-exchanges" title="Permalink to this headline">¶</a></h4>
<p>Topic exchanges matches routing keys using dot-separated words, and can
include wildcard characters: <tt class="docutils literal"><span class="pre">*</span></tt> matches a single word, <tt class="docutils literal"><span class="pre">#</span></tt> matches
zero or more words.</p>
<p>With routing keys like <tt class="docutils literal"><span class="pre">usa.news</span></tt>, <tt class="docutils literal"><span class="pre">usa.weather</span></tt>, <tt class="docutils literal"><span class="pre">norway.news</span></tt> and
<tt class="docutils literal"><span class="pre">norway.weather</span></tt>, bindings could be <tt class="docutils literal"><span class="pre">*.news</span></tt> (all news), <tt class="docutils literal"><span class="pre">usa.#</span></tt> (all
items in the USA) or <tt class="docutils literal"><span class="pre">usa.weather</span></tt> (all USA weather items).</p>
</div>
</div>
<div class="section" id="related-api-commands">
<h3><a class="toc-backref" href="#id8">Related API commands</a><a class="headerlink" href="#related-api-commands" title="Permalink to this headline">¶</a></h3>
<div class="section" id="exchange-declare-exchange-name-type-passive-durable-auto-delete-internal">
<h4><a class="toc-backref" href="#id9">exchange.declare(exchange_name, type, passive, durable, auto_delete, internal)</a><a class="headerlink" href="#exchange-declare-exchange-name-type-passive-durable-auto-delete-internal" title="Permalink to this headline">¶</a></h4>
<p>Declares an exchange by name.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">passive</span></tt> means the exchange won&#8217;t be created, but you can use this to
check if the exchange already exists.</li>
<li>Durable exchanges are persistent. That is - they survive a broker restart.</li>
<li><tt class="docutils literal"><span class="pre">auto_delete</span></tt> means the queue will be deleted by the broker when there
are no more queues using it.</li>
</ul>
</div>
<div class="section" id="queue-declare-queue-name-passive-durable-exclusive-auto-delete">
<h4><a class="toc-backref" href="#id10">queue.declare(queue_name, passive, durable, exclusive, auto_delete)</a><a class="headerlink" href="#queue-declare-queue-name-passive-durable-exclusive-auto-delete" title="Permalink to this headline">¶</a></h4>
<p>Declares a queue by name.</p>
<ul class="simple">
<li>exclusive queues can only be consumed from by the current connection.
implies <tt class="docutils literal"><span class="pre">auto_delete</span></tt>.</li>
</ul>
</div>
<div class="section" id="queue-bind-queue-name-exchange-name-routing-key">
<h4><a class="toc-backref" href="#id11">queue.bind(queue_name, exchange_name, routing_key)</a><a class="headerlink" href="#queue-bind-queue-name-exchange-name-routing-key" title="Permalink to this headline">¶</a></h4>
<p>Binds a queue to an exchange with a routing key.
Unbound queues will not receive messages, so this is necessary.</p>
</div>
<div class="section" id="queue-delete-name-if-unused-if-empty">
<h4><a class="toc-backref" href="#id12">queue.delete(name, if_unused, if_empty)</a><a class="headerlink" href="#queue-delete-name-if-unused-if-empty" title="Permalink to this headline">¶</a></h4>
<p>Deletes a queue and its binding.</p>
</div>
<div class="section" id="exchange-delete-name-if-unused">
<h4><a class="toc-backref" href="#id13">exchange.delete(name, if_unused)</a><a class="headerlink" href="#exchange-delete-name-if-unused" title="Permalink to this headline">¶</a></h4>
<p>Deletes an exchange.</p>
<p><strong>NOTE</strong>: Declaring does not necessarily mean &#8220;create&#8221;. When you declare you
<em>assert</em> that the entity exists and that it&#8217;s operable. There is no rule as to
whom should initially create the exchange/queue/binding, whether consumer
or producer. Usually the first one to need it will be the one to create it.</p>
</div>
</div>
<div class="section" id="hands-on-with-the-api">
<h3><a class="toc-backref" href="#id14">Hands-on with the API</a><a class="headerlink" href="#hands-on-with-the-api" title="Permalink to this headline">¶</a></h3>
<p>Celery comes with a tool called <tt class="docutils literal"><span class="pre">camqadm</span></tt> (short for celery AMQP admin).
It&#8217;s used for simple admnistration tasks like creating/deleting queues and
exchanges, purging queues and sending messages. In short it&#8217;s for simple
command-line access to the AMQP API.</p>
<p>You can write commands directly in the arguments to <tt class="docutils literal"><span class="pre">camqadm</span></tt>, or just start
with no arguments to start it in shell-mode:</p>
<div class="highlight-python"><pre>$ camqadm
-&gt; connecting to amqp://guest@localhost:5672/.
-&gt; connected.
1&gt;</pre>
</div>
<p>Here <tt class="docutils literal"><span class="pre">1&gt;</span></tt> is the prompt. The number is counting the number of commands you
have executed. Type <tt class="docutils literal"><span class="pre">help</span></tt> for a list of commands. It also has
autocompletion, so you can start typing a command and then hit the
<tt class="docutils literal"><span class="pre">tab</span></tt> key to show a list of possible matches.</p>
<p>Now let&#8217;s create a queue we can send messages to:</p>
<div class="highlight-python"><pre>1&gt; exchange.declare testexchange direct
ok.
2&gt; queue.declare testqueue
ok. queue:testqueue messages:0 consumers:0.
3&gt; queue.bind testqueue testexchange testkey
ok.</pre>
</div>
<p>This created the direct exchange <tt class="docutils literal"><span class="pre">testexchange</span></tt>, and a queue
named <tt class="docutils literal"><span class="pre">testqueue</span></tt>.  The queue is bound to the exchange using
the routing key <tt class="docutils literal"><span class="pre">testkey</span></tt>.</p>
<p>From now on all messages sent to the exchange <tt class="docutils literal"><span class="pre">testexchange</span></tt> with routing
key <tt class="docutils literal"><span class="pre">testkey</span></tt> will be moved to this queue. We can send a message by
using the <tt class="docutils literal"><span class="pre">basic.publish</span></tt> command:</p>
<div class="highlight-python"><pre>4&gt; basic.publish "This is a message!" testexchange testkey
ok.</pre>
</div>
<p>Now that the message is sent we can retrieve it again. We use the
<tt class="docutils literal"><span class="pre">basic.get</span></tt> command here, which pops a single message off the queue,
this command is not recommended for production as it implies polling, any
real application would declare consumers instead.</p>
<p>Pop a message off the queue:</p>
<div class="highlight-python"><pre>5&gt; basic.get testqueue
{'body': 'This is a message!',
 'delivery_info': {'delivery_tag': 1,
                   'exchange': u'testexchange',
                   'message_count': 0,
                   'redelivered': False,
                   'routing_key': u'testkey'},
 'properties': {}}</pre>
</div>
<p>AMQP uses acknowledgment to signify that a message has been received
and processed successfully. The message is sent to the next receiver
if it has not been acknowledged before the client connection is closed.</p>
<p>Note the delivery tag listed in the structure above; Within a connection channel,
every received message has a unique delivery tag,
This tag is used to acknowledge the message. Note that
delivery tags are not unique across connections, so in another client
the delivery tag <tt class="docutils literal"><span class="pre">1</span></tt> might point to a different message than in this channel.</p>
<p>You can acknowledge the message we received using <tt class="docutils literal"><span class="pre">basic.ack</span></tt>:</p>
<div class="highlight-python"><pre>6&gt; basic.ack 1
ok.</pre>
</div>
<p>To clean up after our test session we should delete the entities we created:</p>
<div class="highlight-python"><pre>7&gt; queue.delete testqueue
ok. 0 messages deleted.
8&gt; exchange.delete testexchange
ok.</pre>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../configuration.html" title="Configuration and defaults"
             >next</a> |</li>
        <li class="right" >
          <a href="remote-tasks.html" title="HTTP Callback Tasks (Webhooks)"
             >previous</a> |</li>
        <li><a href="../index.html">Celery v1.1.1 (unstable) documentation</a> &raquo;</li>
          <li><a href="index.html" >User Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, Ask Solem.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0b2.
    </div>
  </body>
</html>