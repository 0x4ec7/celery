
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tasks &mdash; Celery v2.0.2 (stable) documentation</title>
    <link rel="stylesheet" href="../static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0.2 (stable)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Celery v2.0.2 (stable) documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Executing Tasks" href="executing.html" />
    <link rel="prev" title="User Guide" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="executing.html" title="Executing Tasks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="User Guide"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Celery v2.0.2 (stable) documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">User Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-celery.task.base">
<span id="tasks"></span><h1>Tasks<a class="headerlink" href="#module-celery.task.base" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference external" href="#basics" id="id1">Basics</a></li>
<li><a class="reference external" href="#default-keyword-arguments" id="id2">Default keyword arguments</a></li>
<li><a class="reference external" href="#logging" id="id3">Logging</a></li>
<li><a class="reference external" href="#retrying-a-task-if-something-fails" id="id4">Retrying a task if something fails</a><ul>
<li><a class="reference external" href="#using-a-custom-retry-delay" id="id5">Using a custom retry delay</a></li>
</ul>
</li>
<li><a class="reference external" href="#task-options" id="id6">Task options</a><ul>
<li><a class="reference external" href="#message-and-routing-options" id="id7">Message and routing options</a></li>
</ul>
</li>
<li><a class="reference external" href="#example" id="id8">Example</a><ul>
<li><a class="reference external" href="#blog-models-py" id="id9">blog/models.py</a></li>
<li><a class="reference external" href="#blog-views-py" id="id10">blog/views.py</a></li>
<li><a class="reference external" href="#blog-tasks-py" id="id11">blog/tasks.py</a></li>
</ul>
</li>
<li><a class="reference external" href="#how-it-works" id="id12">How it works</a></li>
<li><a class="reference external" href="#tips-and-best-practices" id="id13">Tips and Best Practices</a><ul>
<li><a class="reference external" href="#ignore-results-you-don-t-want" id="id14">Ignore results you don&#8217;t want</a></li>
<li><a class="reference external" href="#disable-rate-limits-if-they-re-not-used" id="id15">Disable rate limits if they&#8217;re not used</a></li>
<li><a class="reference external" href="#avoid-launching-synchronous-subtasks" id="id16">Avoid launching synchronous subtasks</a></li>
</ul>
</li>
<li><a class="reference external" href="#performance-and-strategies" id="id17">Performance and Strategies</a><ul>
<li><a class="reference external" href="#granularity" id="id18">Granularity</a></li>
<li><a class="reference external" href="#data-locality" id="id19">Data locality</a></li>
<li><a class="reference external" href="#state" id="id20">State</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="basics">
<h2><a class="toc-backref" href="#id1">Basics</a><a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>A task is a class that encapsulates a function and its execution options.
Given a function <tt class="docutils literal"><span class="pre">create_user</span></tt>, that takes two arguments: <tt class="docutils literal"><span class="pre">username</span></tt> and
<tt class="docutils literal"><span class="pre">password</span></tt>, you can create a task like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">CreateUserTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>For convenience there is a shortcut decorator that turns any function into
a task, <a class="reference internal" href="../reference/celery.decorators.html#celery.decorators.task" title="celery.decorators.task"><tt class="xref py py-func docutils literal"><span class="pre">celery.decorators.task()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>The task decorator takes the same execution options as the
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task" title="celery.task.base.Task"><tt class="xref py py-class docutils literal"><span class="pre">Task</span></tt></a> class does:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">&quot;json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="default-keyword-arguments">
<h2><a class="toc-backref" href="#id2">Default keyword arguments</a><a class="headerlink" href="#default-keyword-arguments" title="Permalink to this headline">¶</a></h2>
<p>Celery supports a set of default arguments that can be forwarded to any task.
Tasks can choose not to take these, or list the ones they want.
The worker will do the right thing.</p>
<p>The current default keyword arguments are:</p>
<ul>
<li><p class="first">logfile</p>
<blockquote>
<p>The log file, can be passed on to
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.get_logger" title="celery.task.base.Task.get_logger"><tt class="xref py py-meth docutils literal"><span class="pre">get_logger()</span></tt></a> to gain access to
the workers log file. See <a class="reference external" href="#logging">Logging</a>.</p>
</blockquote>
</li>
<li><p class="first">loglevel</p>
<blockquote>
<p>The loglevel used.</p>
</blockquote>
</li>
<li><p class="first">task_id</p>
<blockquote>
<p>The unique id of the executing task.</p>
</blockquote>
</li>
<li><p class="first">task_name</p>
<blockquote>
<p>Name of the executing task.</p>
</blockquote>
</li>
<li><p class="first">task_retries</p>
<blockquote>
<p>How many times the current task has been retried.
An integer starting at <tt class="docutils literal"><span class="pre">0</span></tt>.</p>
</blockquote>
</li>
<li><p class="first">task_is_eager</p>
<blockquote>
<p>Set to <tt class="xref py py-const xref docutils literal"><span class="pre">True</span></tt> if the task is executed locally in the client,
and not by a worker.</p>
</blockquote>
</li>
<li><p class="first">delivery_info</p>
<p>Additional message delivery information. This is a mapping containing
the exchange and routing key used to deliver this task. It&#8217;s used
by e.g. <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.retry" title="celery.task.base.Task.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a> to resend the task to the
same destination queue.</p>
<p><strong>NOTE</strong> As some messaging backends doesn&#8217;t have advanced routing
capabilities, you can&#8217;t trust the availability of keys in this mapping.</p>
</li>
</ul>
</div>
<div class="section" id="logging">
<h2><a class="toc-backref" href="#id3">Logging</a><a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>You can use the workers logger to add diagnostic output to
the worker log:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>or using the decorator syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>There are several logging levels available, and the workers <tt class="docutils literal"><span class="pre">loglevel</span></tt>
setting decides whether or not they will be written to the log file.</p>
<p>Of course, you can also simply use <tt class="docutils literal"><span class="pre">print</span></tt> as anything written to standard
out/-err will be written to the logfile as well.</p>
</div>
<div class="section" id="retrying-a-task-if-something-fails">
<h2><a class="toc-backref" href="#id4">Retrying a task if something fails</a><a class="headerlink" href="#retrying-a-task-if-something-fails" title="Permalink to this headline">¶</a></h2>
<p>Simply use <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.retry" title="celery.task.base.Task.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a> to re-send the task.
It will do the right thing, and respect the
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.max_retries" title="celery.task.base.Task.max_retries"><tt class="xref py py-attr docutils literal"><span class="pre">max_retries</span></tt></a> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">),</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">send_twitter_status</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we used the <tt class="docutils literal"><span class="pre">exc</span></tt> argument to pass the current exception to
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.retry" title="celery.task.base.Task.retry"><tt class="xref py py-meth docutils literal"><span class="pre">Task.retry()</span></tt></a>. At each step of the retry this exception
is available as the tombstone (result) of the task. When
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.max_retries" title="celery.task.base.Task.max_retries"><tt class="xref py py-attr docutils literal"><span class="pre">Task.max_retries</span></tt></a> has been exceeded this is the exception
raised. However, if an <tt class="docutils literal"><span class="pre">exc</span></tt> argument is not provided the
<tt class="xref py py-exc docutils literal"><span class="pre">RetryTaskError</span></tt> exception is raised instead.</p>
<p><strong>Important note:</strong> The task has to take the magic keyword arguments
in order for max retries to work properly, this is because it keeps track
of the current number of retries using the <tt class="docutils literal"><span class="pre">task_retries</span></tt> keyword argument
passed on to the task. In addition, it also uses the <tt class="docutils literal"><span class="pre">task_id</span></tt> keyword
argument to use the same task id, and <tt class="docutils literal"><span class="pre">delivery_info</span></tt> to route the
retried task to the same destination.</p>
<div class="section" id="using-a-custom-retry-delay">
<h3><a class="toc-backref" href="#id5">Using a custom retry delay</a><a class="headerlink" href="#using-a-custom-retry-delay" title="Permalink to this headline">¶</a></h3>
<p>When a task is to be retried, it will wait for a given amount of time
before doing so. The default delay is in the <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.default_retry_delay" title="celery.task.base.Task.default_retry_delay"><tt class="xref py py-attr docutils literal"><span class="pre">Task.default_retry_delay</span></tt></a>
attribute on the task. By default this is set to 3 minutes. Note that the
unit for setting the delay is in seconds (int or float).</p>
<p>You can also provide the <tt class="docutils literal"><span class="pre">countdown</span></tt> argument to
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.retry" title="celery.task.base.Task.retry"><tt class="xref py py-meth docutils literal"><span class="pre">retry()</span></tt></a> to override this default.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">default_retry_delay</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="c"># retry in 30 minutes</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
                       <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="c"># override the default and</span>
                                     <span class="c"># - retry in 1 minute</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="task-options">
<h2><a class="toc-backref" href="#id6">Task options</a><a class="headerlink" href="#task-options" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">name</p>
<blockquote>
<p>The name the task is registered as.
You can set this name manually, or just use the default which is
automatically generated using the module and class name.</p>
</blockquote>
</li>
<li><p class="first">abstract</p>
<blockquote>
<p>Abstract classes are not registered, but are used as the superclass
when making new task types by subclassing.</p>
</blockquote>
</li>
<li><p class="first">max_retries</p>
<blockquote>
<p>The maximum number of attempted retries before giving up.
If this is exceeded the :exc`~celery.execptions.MaxRetriesExceeded`
exception will be raised. Note that you have to retry manually, it&#8217;s
not something that happens automatically.</p>
</blockquote>
</li>
<li><p class="first">default_retry_delay</p>
<blockquote>
<p>Default time in seconds before a retry of the task should be
executed. Can be either an <tt class="docutils literal"><span class="pre">int</span></tt> or a <tt class="docutils literal"><span class="pre">float</span></tt>.
Default is a 1 minute delay (<tt class="docutils literal"><span class="pre">60</span> <span class="pre">seconds</span></tt>).</p>
</blockquote>
</li>
<li><p class="first">rate_limit</p>
<p>Set the rate limit for this task type, that is, how many times in a given
period of time is the task allowed to run.</p>
<p>If this is <tt class="xref docutils literal"><span class="pre">None</span></tt> no rate limit is in effect.
If it is an integer, it is interpreted as &#8220;tasks per second&#8221;.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <tt class="docutils literal"><span class="pre">&quot;/s&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;/m&quot;</span></tt> or &#8220;<tt class="docutils literal"><span class="pre">/h&quot;</span></tt>&#8221; to the value.
Example: <tt class="docutils literal"><span class="pre">&quot;100/m&quot;</span> <span class="pre">(hundred</span> <span class="pre">tasks</span> <span class="pre">a</span>
<span class="pre">minute).</span> <span class="pre">Default</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">``CELERY_DEFAULT_RATE_LIMIT</span></tt> setting, which if not
specified means rate limiting for tasks is turned off by default.</p>
</li>
<li><p class="first">ignore_result</p>
<dl class="docutils">
<dt>Don&#8217;t store the status and return value. This means you can&#8217;t</dt>
<dd><p class="first last">use the <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><tt class="xref py py-class docutils literal"><span class="pre">celery.result.AsyncResult</span></tt></a> to check if the task is
done, or get its return value. Only use if you need the performance
and is able live without these features. Any exceptions raised will
store the return value/status as usual.</p>
</dd>
</dl>
</li>
<li><p class="first">disable_error_emails</p>
<blockquote>
<p>Disable error e-mails for this task. Default is <tt class="xref docutils literal"><span class="pre">False</span></tt>.
<em>Note:</em> You can also turn off error e-mails globally using the
<tt class="docutils literal"><span class="pre">CELERY_SEND_TASK_ERROR_EMAILS</span></tt> setting.</p>
</blockquote>
</li>
<li><p class="first">serializer</p>
<blockquote>
<p>A string identifying the default serialization
method to use. Defaults to the <tt class="docutils literal"><span class="pre">CELERY_TASK_SERIALIZER</span></tt> setting.
Can be <tt class="docutils literal"><span class="pre">pickle</span></tt> <tt class="docutils literal"><span class="pre">json</span></tt>, <tt class="docutils literal"><span class="pre">yaml</span></tt>, or any custom serialization
methods that have been registered with
<tt class="xref py py-mod docutils literal"><span class="pre">carrot.serialization.registry</span></tt>.</p>
<p>Please see <a class="reference internal" href="executing.html"><em>Executing Tasks</em></a> for more information.</p>
</blockquote>
</li>
</ul>
<div class="section" id="message-and-routing-options">
<h3><a class="toc-backref" href="#id7">Message and routing options</a><a class="headerlink" href="#message-and-routing-options" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">queue</p>
<blockquote>
<p>Use the routing settings from a queue defined in <tt class="docutils literal"><span class="pre">CELERY_QUEUES</span></tt>.
If defined the <tt class="docutils literal"><span class="pre">exchange</span></tt> and <tt class="docutils literal"><span class="pre">routing_key</span></tt> options will be ignored.</p>
</blockquote>
</li>
<li><p class="first">exchange</p>
<blockquote>
<p>Override the global default <tt class="docutils literal"><span class="pre">exchange</span></tt> for this task.</p>
</blockquote>
</li>
<li><p class="first">routing_key</p>
<blockquote>
<p>Override the global default <tt class="docutils literal"><span class="pre">routing_key</span></tt> for this task.</p>
</blockquote>
</li>
<li><dl class="first docutils">
<dt>mandatory</dt>
<dd><p class="first last">If set, the task message has mandatory routing. By default the task
is silently dropped by the broker if it can&#8217;t be routed to a queue.
However - If the task is mandatory, an exception will be raised
instead.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>immediate</dt>
<dd><p class="first last">Request immediate delivery. If the task cannot be routed to a
task worker immediately, an exception will be raised. This is
instead of the default behavior, where the broker will accept and
queue the task, but with no guarantee that the task will ever
be executed.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>priority</dt>
<dd><p class="first last">The message priority. A number from <tt class="docutils literal"><span class="pre">0</span></tt> to <tt class="docutils literal"><span class="pre">9</span></tt>, where <tt class="docutils literal"><span class="pre">0</span></tt> is the
highest. <strong>Note:</strong> RabbitMQ does not support priorities yet.</p>
</dd>
</dl>
</li>
</ul>
<p>See <a class="reference internal" href="executing.html"><em>Executing Tasks</em></a> for more information about the messaging options
available, also <a class="reference internal" href="routing.html"><em>Routing Tasks</em></a>.</p>
</div>
</div>
<div class="section" id="example">
<h2><a class="toc-backref" href="#id8">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s take a real wold example; A blog where comments posted needs to be
filtered for spam. When the comment is created, the spam filter runs in the
background, so the user doesn&#8217;t have to wait for it to finish.</p>
<p>We have a Django blog application allowing comments
on blog posts. We&#8217;ll describe parts of the models/views and tasks for this
application.</p>
<div class="section" id="blog-models-py">
<h3><a class="toc-backref" href="#id9">blog/models.py</a><a class="headerlink" href="#blog-models-py" title="Permalink to this headline">¶</a></h3>
<p>The comment model looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;e-mail address&quot;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;home page&quot;</span><span class="p">),</span>
                               <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Published date&quot;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;spam?&quot;</span><span class="p">),</span>
                                  <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the view where the comment is posted, we first write the comment
to the database, then we launch the spam filter task in the background.</p>
</div>
<div class="section" id="blog-views-py">
<h3><a class="toc-backref" href="#id10">blog/views.py</a><a class="headerlink" href="#blog-views-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>from django import forms
frmo django.http import HttpResponseRedirect
from django.template.context import RequestContext
from django.shortcuts import get_object_or_404, render_to_response

from blog import tasks
from blog.models import Comment


class CommentForm(forms.ModelForm):

    class Meta:
        model = Comment


def add_comment(request, slug, template_name="comments/create.html"):
    post = get_object_or_404(Entry, slug=slug)
    remote_addr = request.META.get("REMOTE_ADDR")

    if request.method == "post":
        form = CommentForm(request.POST, request.FILES)
        if form.is_valid():
            comment = form.save()
            # Check spam asynchronously.
            tasks.spam_filter.delay(comment_id=comment.id,
                                    remote_addr=remote_addr)
            return HttpResponseRedirect(post.get_absolute_url())
    else:
        form = CommentForm()

    context = RequestContext(request, {"form": form})
    return render_to_response(template_name, context_instance=context)</pre>
</div>
<p>To filter spam in comments we use <a class="reference external" href="http://akismet.com/faq/">Akismet</a>, the service
used to filter spam in comments posted to the free weblog platform
<cite>Wordpress</cite>. <a class="reference external" href="http://akismet.com/faq/">Akismet</a> is free for personal use, but for commercial use you
need to pay. You have to sign up to their service to get an API key.</p>
<p>To make API calls to <a class="reference external" href="http://akismet.com/faq/">Akismet</a> we use the <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> library written by
Michael Foord.</p>
</div>
<div class="section" id="blog-tasks-py">
<h3><a class="toc-backref" href="#id11">blog/tasks.py</a><a class="headerlink" href="#blog-tasks-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">akismet</span> <span class="kn">import</span> <span class="n">Akismet</span>
<span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">spam_filter</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">spam_filter</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running spam filter for comment </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">comment_id</span><span class="p">)</span>

        <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
        <span class="n">current_domain</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
        <span class="n">akismet</span> <span class="o">=</span> <span class="n">Akismet</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AKISMET_KEY</span><span class="p">,</span> <span class="s">&quot;http://</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;Invalid AKISMET_KEY&quot;</span><span class="p">)</span>


        <span class="n">is_spam</span> <span class="o">=</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">user_ip</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">,</span>
                            <span class="n">comment_content</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                            <span class="n">comment_author</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">comment_author_email</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_spam</span><span class="p">:</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">is_spam</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-it-works">
<h2><a class="toc-backref" href="#id12">How it works</a><a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>Here comes the technical details, this part isn&#8217;t something you need to know,
but you may be interested.</p>
<p>All defined tasks are listed in a registry. The registry contains
a list of task names and their task classes. You can investigate this registry
yourself:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">task</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">registry</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.delete_expired_task_meta&#39;:</span>
<span class="go">    &lt;PeriodicTask: celery.delete_expired_task_meta (periodic)&gt;,</span>
<span class="go"> &#39;celery.task.http.HttpDispatchTask&#39;:</span>
<span class="go">    &lt;Task: celery.task.http.HttpDispatchTask (regular)&gt;,</span>
<span class="go"> &#39;celery.execute_remote&#39;:</span>
<span class="go">    &lt;Task: celery.execute_remote (regular)&gt;,</span>
<span class="go"> &#39;celery.map_async&#39;:</span>
<span class="go">    &lt;Task: celery.map_async (regular)&gt;,</span>
<span class="go"> &#39;celery.ping&#39;:</span>
<span class="go">    &lt;Task: celery.ping (regular)&gt;}</span>
</pre></div>
</div>
<p>This is the list of tasks built-in to celery. Note that we had to import
<tt class="docutils literal"><span class="pre">celery.task</span></tt> first for these to show up. This is because the tasks will
only be registered when the module they are defined in is imported.</p>
<p>The default loader imports any modules listed in the
<tt class="docutils literal"><span class="pre">CELERY_IMPORTS</span></tt> setting.</p>
<p>The entity responsible for registering your task in the registry is a
meta class, <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.TaskType" title="celery.task.base.TaskType"><tt class="xref py py-class docutils literal"><span class="pre">TaskType</span></tt></a>. This is the default
meta class for <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task" title="celery.task.base.Task"><tt class="xref py py-class docutils literal"><span class="pre">Task</span></tt></a>. If you want to register
your task manually you can set the <a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.abstract" title="celery.task.base.Task.abstract"><tt class="xref py py-attr docutils literal"><span class="pre">abstract</span></tt></a>
attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>This way the task won&#8217;t be registered, but any task subclassing it will.</p>
<p>When tasks are sent, we don&#8217;t send the function code, just the name
of the task. When the worker receives the message it can just look it up in
the task registry to find the execution code.</p>
<p>This means that your workers should always be updated with the same software
as the client. This is a drawback, but the alternative is a technical
challenge that has yet to be solved.</p>
</div>
<div class="section" id="tips-and-best-practices">
<h2><a class="toc-backref" href="#id13">Tips and Best Practices</a><a class="headerlink" href="#tips-and-best-practices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ignore-results-you-don-t-want">
<h3><a class="toc-backref" href="#id14">Ignore results you don&#8217;t want</a><a class="headerlink" href="#ignore-results-you-don-t-want" title="Permalink to this headline">¶</a></h3>
<p>If you don&#8217;t care about the results of a task, be sure to set the
<a class="reference internal" href="../reference/celery.task.base.html#celery.task.base.Task.ignore_result" title="celery.task.base.Task.ignore_result"><tt class="xref py py-attr docutils literal"><span class="pre">ignore_result</span></tt></a> option, as storing results
wastes time and resources.</p>
<div class="highlight-python"><pre>@task(ignore_result=True)
def mytask(...)
    something()</pre>
</div>
<p>Results can even be disabled globally using the <tt class="docutils literal"><span class="pre">CELERY_IGNORE_RESULT</span></tt>
setting.</p>
</div>
<div class="section" id="disable-rate-limits-if-they-re-not-used">
<h3><a class="toc-backref" href="#id15">Disable rate limits if they&#8217;re not used</a><a class="headerlink" href="#disable-rate-limits-if-they-re-not-used" title="Permalink to this headline">¶</a></h3>
<p>Disabling rate limits altogether is recommended if you don&#8217;t have
any tasks using them. This is because the rate limit subsystem introduces
quite a lot of complexity.</p>
<p>Set the <tt class="docutils literal"><span class="pre">CELERY_DISABLE_RATE_LIMITS</span></tt> setting to globally disable
rate limits:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CELERY_DISABLE_RATE_LIMITS</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="avoid-launching-synchronous-subtasks">
<h3><a class="toc-backref" href="#id16">Avoid launching synchronous subtasks</a><a class="headerlink" href="#avoid-launching-synchronous-subtasks" title="Permalink to this headline">¶</a></h3>
<p>Having a task wait for the result of another task is really inefficient,
and may even cause a deadlock if the worker pool is exhausted.</p>
<p>Make your design asynchronous instead, for example by using <em>callbacks</em>.</p>
<p>Bad:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>Good:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c"># fetch_page -&gt; parse_page -&gt; store_page</span>
    <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">subtask</span><span class="p">(</span><span class="n">parse_page</span><span class="p">,</span>
                                <span class="n">callback</span><span class="o">=</span><span class="n">subtask</span><span class="p">(</span><span class="n">store_page_info</span><span class="p">)))</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="c"># The callback may have been serialized with JSON,</span>
        <span class="c"># so best practice is to convert the subtask dict back</span>
        <span class="c"># into a subtask object.</span>
        <span class="n">subtask</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="n">subtask</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>We use <a class="reference internal" href="../reference/celery.task.sets.html#celery.task.sets.subtask" title="celery.task.sets.subtask"><tt class="xref py py-class docutils literal"><span class="pre">subtask</span></tt></a> here to safely pass
around the callback task. <a class="reference internal" href="../reference/celery.task.sets.html#celery.task.sets.subtask" title="celery.task.sets.subtask"><tt class="xref py py-class docutils literal"><span class="pre">subtask</span></tt></a> is a
subclass of dict used to wrap the arguments and execution options
for a single task invocation. See <a class="reference internal" href="tasksets.html"><em>Sets of tasks, Subtasks and Callbacks</em></a> for more information about
subtasks.</p>
</div>
</div>
<div class="section" id="performance-and-strategies">
<h2><a class="toc-backref" href="#id17">Performance and Strategies</a><a class="headerlink" href="#performance-and-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="granularity">
<h3><a class="toc-backref" href="#id18">Granularity</a><a class="headerlink" href="#granularity" title="Permalink to this headline">¶</a></h3>
<p>The task&#8217;s granularity is the degree of parallelization your task have.
It&#8217;s better to have many small tasks, than a few long running ones.</p>
<p>With smaller tasks, you can process more tasks in parallel and the tasks
won&#8217;t run long enough to block the worker from processing other waiting tasks.</p>
<p>However, there&#8217;s a limit. Sending messages takes processing power and bandwidth. If
your tasks are so short the overhead of passing them around is worse than
just executing them in-line, you should reconsider your strategy. There is no
universal answer here.</p>
</div>
<div class="section" id="data-locality">
<h3><a class="toc-backref" href="#id19">Data locality</a><a class="headerlink" href="#data-locality" title="Permalink to this headline">¶</a></h3>
<p>The worker processing the task should be as close to the data as
possible. The best would be to have a copy in memory, the worst being a
full transfer from another continent.</p>
<p>If the data is far away, you could try to run another worker at location, or
if that&#8217;s not possible, cache often used data, or preload data you know
is going to be used.</p>
<p>The easiest way to share data between workers is to use a distributed caching
system, like <a class="reference external" href="http://memcached.org/">memcached</a>.</p>
<p>For more information about data-locality, please read
<a class="reference external" href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">http://research.microsoft.com/pubs/70001/tr-2003-24.pdf</a></p>
</div>
<div class="section" id="state">
<h3><a class="toc-backref" href="#id20">State</a><a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p>Since celery is a distributed system, you can&#8217;t know in which process, or even
on what machine the task will run. Indeed you can&#8217;t even know if the task will
run in a timely manner, so please be wary of the state you pass on to tasks.</p>
<p>One gotcha is Django model objects. They shouldn&#8217;t be passed on as arguments
to task classes, it&#8217;s almost always better to re-fetch the object from the
database instead, as there are possible race conditions involved.</p>
<p>Imagine the following scenario where you have an article and a task
that automatically expands some abbreviations in it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;MyCorp&quot;</span><span class="p">,</span> <span class="s">&quot;My Corporation&quot;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>First, an author creates an article and saves it, then the author
clicks on a button that initiates the abbreviation task.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">model_object</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the queue is very busy, so the task won&#8217;t be run for another 2 minutes,
in the meantime another author makes some changes to the article,
when the task is finally run, the body of the article is reverted to the old
version, because the task had the old body in its argument.</p>
<p>Fixing the race condition is easy, just use the article id instead, and
re-fetch the article in the task body:</p>
<div class="highlight-python"><pre>@task
def expand_abbreviations(article_id)
    article = Article.objects.get(id=article_id)
    article.body.replace("MyCorp", "My Corporation")
    article.save()

&gt;&gt;&gt; expand_abbreviations(article_id)</pre>
</div>
<p>There might even be performance benefits to this approach, as sending large
messages may be expensive.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="http://cloud.github.com/downloads/ask/celery/celery_favicon_128.png" alt="Logo"/>
</a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tasks</a><ul>
<li><a class="reference internal" href="#basics">Basics</a></li>
<li><a class="reference internal" href="#default-keyword-arguments">Default keyword arguments</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
<li><a class="reference internal" href="#retrying-a-task-if-something-fails">Retrying a task if something fails</a><ul>
<li><a class="reference internal" href="#using-a-custom-retry-delay">Using a custom retry delay</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-options">Task options</a><ul>
<li><a class="reference internal" href="#message-and-routing-options">Message and routing options</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example">Example</a><ul>
<li><a class="reference internal" href="#blog-models-py">blog/models.py</a></li>
<li><a class="reference internal" href="#blog-views-py">blog/views.py</a></li>
<li><a class="reference internal" href="#blog-tasks-py">blog/tasks.py</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-it-works">How it works</a></li>
<li><a class="reference internal" href="#tips-and-best-practices">Tips and Best Practices</a><ul>
<li><a class="reference internal" href="#ignore-results-you-don-t-want">Ignore results you don&#8217;t want</a></li>
<li><a class="reference internal" href="#disable-rate-limits-if-they-re-not-used">Disable rate limits if they&#8217;re not used</a></li>
<li><a class="reference internal" href="#avoid-launching-synchronous-subtasks">Avoid launching synchronous subtasks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-and-strategies">Performance and Strategies</a><ul>
<li><a class="reference internal" href="#granularity">Granularity</a></li>
<li><a class="reference internal" href="#data-locality">Data locality</a></li>
<li><a class="reference internal" href="#state">State</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">User Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="executing.html"
                        title="next chapter">Executing Tasks</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../sources/userguide/tasks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="executing.html" title="Executing Tasks"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="User Guide"
             >previous</a> |</li>
        <li><a href="../index.html">Celery v2.0.2 (stable) documentation</a> &raquo;</li>
          <li><a href="index.html" >User Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, Ask Solem.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0b2.
    </div>
  </body>
</html>