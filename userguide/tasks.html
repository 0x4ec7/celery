<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tasks &mdash; Celery v1.0.0 (stable) documentation</title>
    <link rel="stylesheet" href="../static/adctheme.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0 (stable)',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="Celery v1.0.0 (stable) documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Executing Tasks" href="executing.html" />
    <link rel="prev" title="User Guide" href="index.html" /> 
  </head>
  <body>
<div id="docstitle">
	<p>Celery v1.0.0 (stable) documentation</p>
</div>
<div id="header">
	<div id="title"><h1>Tasks</h1></div>
	<ul id="headerButtons">
		<li id="toc_button"><div class="headerButton"><a href="#">Table of Contents</a></div></li>
		<li id="page_buttons">
			<div class="headerButton"><a href="../genindex.html" title="General Index" accesskey="I">index</a></div>
			<div class="headerButton"><a href="../modindex.html" title="Global Module Index" accesskey="M">modules</a></div>
			<div class="headerButton"><a href="executing.html" title="Executing Tasks" accesskey="N">next</a></div>
			<div class="headerButton"><a href="index.html" title="User Guide" accesskey="P">previous</a></div>
		</li>
	</ul>
</div>

<div id="sphinxsidebar">
  <div class="sphinxsidebarwrapper">
	<ul><li class="toctree-l1"><a href="../index.html">Main Page</a></li></ul>
	<ul class="current">
<li class="toctree-l1"><a class="reference external" href="../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference external" href="index.html">User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference external" href="">Tasks</a></li>
<li class="toctree-l2"><a class="reference external" href="executing.html">Executing Tasks</a></li>
<li class="toctree-l2"><a class="reference external" href="remote-tasks.html">HTTP Callback Tasks (Webhooks)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="../configuration.html">Configuration and defaults</a></li>
<li class="toctree-l1"><a class="reference external" href="../cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference external" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference external" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="../internals/index.html">Internals</a></li>
<li class="toctree-l1"><a class="reference external" href="../changelog.html">Change history</a></li>
<li class="toctree-l1"><a class="reference external" href="../links.html">Interesting Links</a></li>
</ul>

      <h3>This Page</h3>
      <ul class="this-page-menu">
        <li><a href="../sources/userguide/tasks.txt"
               rel="nofollow">Show Source</a></li>
      </ul>
    <div id="searchbox" style="display: none">
      
        <form class="search" action="../search.html" method="get">
			<div class="search-wrapper">
			<span class="search-left"></span>
			<input class="prettysearch" type="text" name="q" size="18" />
			<span class="search-right">&nbsp;</span>
			</div>
          <input type="submit" value="Search" class="searchbutton" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
        <p class="searchtip" style="font-size: 90%">
        Enter search terms or a module, class or function name.
        </p>
    </div>
    <script type="text/javascript">$('#searchbox').show(0);</script>
  </div>
</div>



    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-celery.task.base">
<h1>Tasks<a class="headerlink" href="#module-celery.task.base" title="Permalink to this headline">¶</a></h1>
<p>A task is a class that encapsulates a function and its execution options.
Given a function <tt class="docutils literal"><span class="pre">create_user</span></tt>, that takes two arguments: <tt class="docutils literal"><span class="pre">username</span></tt> and
<tt class="docutils literal"><span class="pre">password</span></tt>, you can create a task like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">CreateUserTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>For convenience there is a shortcut decorator that turns any function into
a task, <tt class="docutils literal"><span class="pre">celery.decorators.task</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>The task decorator takes the same execution options the <tt class="docutils literal"><span class="pre">Task</span></tt> class does:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">&quot;json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>An alternative way to use the decorator is to give the function as an argument
instead, but if you do this be sure to set the resulting tasks <tt class="docutils literal"><span class="pre">__name__</span></tt>
attribute, so pickle is able to find it in reverse:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">create_user_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">()(</span><span class="n">create_user</span><span class="p">)</span>
<span class="n">create_user_task</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&quot;create_user_task&quot;</span>
</pre></div>
</div>
<div class="section" id="default-keyword-arguments">
<h2>Default keyword arguments<a class="headerlink" href="#default-keyword-arguments" title="Permalink to this headline">¶</a></h2>
<p>Celery supports a set of default arguments that can be forwarded to any task.
Tasks can choose not to take these, or list the ones they want.
The worker will do the right thing.</p>
<p>The current default keyword arguments are:</p>
<ul>
<li><p class="first">logfile</p>
<blockquote>
<p>The log file, can be passed on to <tt class="docutils literal"><span class="pre">self.get_logger</span></tt>
to gain access to the workers log file. See <a class="reference internal" href="#logging">Logging</a>.</p>
</blockquote>
</li>
<li><p class="first">loglevel</p>
<blockquote>
<p>The loglevel used.</p>
</blockquote>
</li>
<li><p class="first">task_id</p>
<blockquote>
<p>The unique id of the executing task.</p>
</blockquote>
</li>
<li><p class="first">task_name</p>
<blockquote>
<p>Name of the executing task.</p>
</blockquote>
</li>
<li><p class="first">task_retries</p>
<blockquote>
<p>How many times the current task has been retried.
An integer starting at <tt class="docutils literal"><span class="pre">0</span></tt>.</p>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>You can use the workers logger to add diagnostic output to
the worker log:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>or using the decorator syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%s</span><span class="s"> + </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>There are several logging levels available, and the workers <tt class="docutils literal"><span class="pre">loglevel</span></tt>
setting decides whether or not they will be written to the log file.</p>
</div>
<div class="section" id="retrying-a-task-if-something-fails">
<h2>Retrying a task if something fails<a class="headerlink" href="#retrying-a-task-if-something-fails" title="Permalink to this headline">¶</a></h2>
<p>Simply use <a title="celery.task.base.Task.retry" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.retry"><tt class="xref docutils literal"><span class="pre">Task.retry()</span></tt></a> to re-send the task. It will
do the right thing, and respect the <a title="celery.task.base.Task.max_retries" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.max_retries"><tt class="xref docutils literal"><span class="pre">Task.max_retries</span></tt></a>
attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">),</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">send_twitter_status</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we used the <tt class="docutils literal"><span class="pre">exc</span></tt> argument to pass the current exception to
<a title="celery.task.base.Task.retry" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.retry"><tt class="xref docutils literal"><span class="pre">Task.retry()</span></tt></a>. At each step of the retry this exception
is available as the tombstone (result) of the task. When
<a title="celery.task.base.Task.max_retries" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.max_retries"><tt class="xref docutils literal"><span class="pre">Task.max_retries</span></tt></a> has been exceeded this is the exception
raised. However, if an <tt class="docutils literal"><span class="pre">exc</span></tt> argument is not provided the
<tt class="xref docutils literal"><span class="pre">RetryTaskError</span></tt> exception is raised instead.</p>
<div class="section" id="using-a-custom-retry-delay">
<h3>Using a custom retry delay<a class="headerlink" href="#using-a-custom-retry-delay" title="Permalink to this headline">¶</a></h3>
<p>When a task is to be retried, it will wait for a given amount of time
before doing so. The default delay is in the <a title="celery.task.base.Task.default_retry_delay" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.default_retry_delay"><tt class="xref docutils literal"><span class="pre">Task.default_retry_delay</span></tt></a>
attribute on the task. By default this is set to 3 minutes. Note that the
unit for setting the delay is in seconds (int or float).</p>
<p>You can also provide the <tt class="docutils literal"><span class="pre">countdown</span></tt> argument to
<a title="celery.task.base.Task.retry" class="reference external" href="../reference/celery.task.base.html#celery.task.base.Task.retry"><tt class="xref docutils literal"><span class="pre">Task.retry()</span></tt></a> to override this default.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">default_retry_delay</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="c"># retry in 30 minutes</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
                       <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span> <span class="c"># override the default and</span>
                                     <span class="c"># - retry in 1 minute</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="task-options">
<h2>Task options<a class="headerlink" href="#task-options" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">name</p>
<blockquote>
<p>The name the task is registered as.
You can set this name manually, or just use the default which is
automatically generated using the module and class name.</p>
</blockquote>
</li>
<li><p class="first">abstract</p>
<blockquote>
<p>Abstract classes are not registered, but are used as the superclass
when making new task types by subclassing.</p>
</blockquote>
</li>
<li><p class="first">max_retries</p>
<blockquote>
<p>The maximum number of attempted retries before giving up.
If this is exceeded the :exc`celery.execptions.MaxRetriesExceeded`
exception will be raised. Note that you have to retry manually, it&#8217;s
not something that happens automatically.</p>
</blockquote>
</li>
<li><p class="first">default_retry_delay</p>
<blockquote>
<p>Default time in seconds before a retry of the task should be
executed. Can be either an <tt class="docutils literal"><span class="pre">int</span></tt> or a <tt class="docutils literal"><span class="pre">float</span></tt>.
Default is a 1 minute delay (<tt class="docutils literal"><span class="pre">60</span> <span class="pre">seconds</span></tt>).</p>
</blockquote>
</li>
<li><p class="first">rate_limit</p>
<p>Set the rate limit for this task type, that is, how many times in a given
period of time is the task allowed to run.</p>
<p>If this is <tt class="xref docutils literal"><span class="pre">None</span></tt> no rate limit is in effect.
If it is an integer, it is interpreted as &#8220;tasks per second&#8221;.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <tt class="docutils literal"><span class="pre">&quot;/s&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;/m&quot;</span></tt> or &#8220;<tt class="docutils literal"><span class="pre">/h&quot;</span></tt>&#8221; to the value.
Example: <tt class="docutils literal"><span class="pre">&quot;100/m&quot;</span> <span class="pre">(hundred</span> <span class="pre">tasks</span> <span class="pre">a</span>
<span class="pre">minute).</span> <span class="pre">Default</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">``CELERY_DEFAULT_RATE_LIMIT</span></tt> setting (which
is off if not specified).</p>
</li>
<li><p class="first">ignore_result</p>
<dl class="docutils">
<dt>Don&#8217;t store the status and return value. This means you can&#8217;t</dt>
<dd><p class="first last">use the <a title="celery.result.AsyncResult" class="reference external" href="../reference/celery.result.html#celery.result.AsyncResult"><tt class="xref docutils literal"><span class="pre">celery.result.AsyncResult</span></tt></a> to check if the task is
done, or get its return value. Only use if you need the performance
and is able live without these features. Any exceptions raised will
store the return value/status as usual.</p>
</dd>
</dl>
</li>
<li><p class="first">disable_error_emails</p>
<blockquote>
<p>Disable error e-mails for this task. Default is <tt class="xref docutils literal"><span class="pre">False</span></tt>.
<em>Note:</em> You can also turn off error e-mails globally using the
<tt class="docutils literal"><span class="pre">CELERY_SEND_TASK_ERROR_EMAILS</span></tt> setting.</p>
</blockquote>
</li>
<li><p class="first">serializer</p>
<blockquote>
<p>A string identifying the default serialization
method to use. Defaults to the <tt class="docutils literal"><span class="pre">CELERY_TASK_SERIALIZER</span></tt> setting.
Can be <tt class="docutils literal"><span class="pre">pickle</span></tt> <tt class="docutils literal"><span class="pre">json</span></tt>, <tt class="docutils literal"><span class="pre">yaml</span></tt>, or any custom serialization
methods that have been registered with
<tt class="xref docutils literal"><span class="pre">carrot.serialization.registry</span></tt>.</p>
<p>Please see <a class="reference external" href="executing.html"><em>Executing Tasks</em></a> for more information.</p>
</blockquote>
</li>
</ul>
<div class="section" id="message-and-routing-options">
<h3>Message and routing options<a class="headerlink" href="#message-and-routing-options" title="Permalink to this headline">¶</a></h3>
<ul>
<li><dl class="first docutils">
<dt>routing_key</dt>
<dd><p class="first last">Override the global default <tt class="docutils literal"><span class="pre">routing_key</span></tt> for this task.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>exchange</dt>
<dd><p class="first last">Override the global default <tt class="docutils literal"><span class="pre">exchange</span></tt> for this task.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>mandatory</dt>
<dd><p class="first last">If set, the task message has mandatory routing. By default the task
is silently dropped by the broker if it can&#8217;t be routed to a queue.
However - If the task is mandatory, an exception will be raised
instead.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>immediate</dt>
<dd><p class="first last">Request immediate delivery. If the task cannot be routed to a
task worker immediately, an exception will be raised. This is
instead of the default behavior, where the broker will accept and
queue the task, but with no guarantee that the task will ever
be executed.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>priority</dt>
<dd><p class="first last">The message priority. A number from <tt class="docutils literal"><span class="pre">0</span></tt> to <tt class="docutils literal"><span class="pre">9</span></tt>, where <tt class="docutils literal"><span class="pre">0</span></tt> is the
highest. <strong>Note:</strong> RabbitMQ does not support priorities yet.</p>
</dd>
</dl>
</li>
</ul>
<p>See <a class="reference external" href="executing.html"><em>Executing Tasks</em></a> for more information about the messaging options
available.</p>
</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s take a real wold example; A blog where comments posted needs to be
filtered for spam. When the comment is created, the spam filter runs in the
background, so the user doesn&#8217;t have to wait for it to finish.</p>
<p>We have a Django blog application allowing comments
on blog posts. We&#8217;ll describe parts of the models/views and tasks for this
application.</p>
<div class="section" id="blog-models-py">
<h3>blog/models.py<a class="headerlink" href="#blog-models-py" title="Permalink to this headline">¶</a></h3>
<p>The comment model looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;e-mail address&quot;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;home page&quot;</span><span class="p">),</span>
                               <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Published date&quot;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;spam?&quot;</span><span class="p">),</span>
                                  <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the view where the comment is posted, we first write the comment
to the database, then we launch the spam filter task in the background.</p>
</div>
<div class="section" id="blog-views-py">
<h3>blog/views.py<a class="headerlink" href="#blog-views-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>from django import forms
frmo django.http import HttpResponseRedirect
from django.template.context import RequestContext
from django.shortcuts import get_object_or_404, render_to_response

from blog import tasks
from blog.models import Comment


class CommentForm(forms.ModelForm):

    class Meta:
        model = Comment


def add_comment(request, slug, template_name="comments/create.html"):
    post = get_object_or_404(Entry, slug=slug)
    remote_addr = request.META.get("REMOTE_ADDR")

    if request.method == "post":
        form = CommentForm(request.POST, request.FILES)
        if form.is_valid():
            comment = form.save()
            # Check spam asynchronously.
            tasks.spam_filter.delay(comment_id=comment.id,
                                    remote_addr=remote_addr)
            return HttpResponseRedirect(post.get_absolute_url())
    else:
        form = CommentForm()

    context = RequestContext(request, {"form": form})
    return render_to_response(template_name, context_instance=context)</pre>
</div>
<p>To filter spam in comments we use <a class="reference external" href="http://akismet.com/faq/">Akismet</a>, the service
used to filter spam in comments posted to the free weblog platform
<cite>Wordpress</cite>. <a class="reference external" href="http://akismet.com/faq/">Akismet</a> is free for personal use, but for commercial use you
need to pay. You have to sign up to their service to get an API key.</p>
<p>To make API calls to <a class="reference external" href="http://akismet.com/faq/">Akismet</a> we use the <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> library written by
Michael Foord.</p>
</div>
<div class="section" id="blog-tasks-py">
<h3>blog/tasks.py<a class="headerlink" href="#blog-tasks-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">akismet</span> <span class="kn">import</span> <span class="n">Akismet</span>
<span class="kn">from</span> <span class="nn">celery.decorators</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Comment</span>


<span class="k">def</span> <span class="nf">spam_filter</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">spam_filter</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running spam filter for comment </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">comment_id</span><span class="p">)</span>

        <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
        <span class="n">current_domain</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
        <span class="n">akismet</span> <span class="o">=</span> <span class="n">Akismet</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AKISMET_KEY</span><span class="p">,</span> <span class="s">&quot;http://</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;Invalid AKISMET_KEY&quot;</span><span class="p">)</span>


        <span class="n">is_spam</span> <span class="o">=</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">user_ip</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">,</span>
                            <span class="n">comment_content</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                            <span class="n">comment_author</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">comment_author_email</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_spam</span><span class="p">:</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">is_spam</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-it-works">
<h2>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>Here comes the technical details, this part isn&#8217;t something you need to know,
but you may be interested.</p>
<p>All defined tasks are listed in a registry. The registry contains
a list of task names and their task classes. You can investigate this registry
yourself:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">task</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">registry</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.delete_expired_task_meta&#39;:</span>
<span class="go">  &lt;celery.task.builtins.DeleteExpiredTaskMetaTask object at 0x101d1f510&gt;,</span>
<span class="go">&#39;celery.execute_remote&#39;:</span>
<span class="go">  &lt;celery.task.base.ExecuteRemoteTask object at 0x101d17890&gt;,</span>
<span class="go">&#39;celery.task.rest.RESTProxyTask&#39;:</span>
<span class="go">  &lt;celery.task.rest.RESTProxyTask object at 0x101d1f410&gt;,</span>
<span class="go">&#39;celery.task.rest.Task&#39;: &lt;celery.task.rest.Task object at 0x101d1f4d0&gt;,</span>
<span class="go">&#39;celery.map_async&#39;:</span>
<span class="go">  &lt;celery.task.base.AsynchronousMapTask object at 0x101d17910&gt;,</span>
<span class="go">&#39;celery.ping&#39;: &lt;celery.task.builtins.PingTask object at 0x101d1f550&gt;}</span>
</pre></div>
</div>
<p>This is the list of tasks built-in to celery. Note that we had to import
<tt class="docutils literal"><span class="pre">celery.task</span></tt> first for these to show up. This is because the tasks will
only be registered when the module they are defined in is imported.</p>
<p>The default loader imports any modules listed in the
<tt class="docutils literal"><span class="pre">CELERY_IMPORTS</span></tt> setting. If using Django it loads all <tt class="docutils literal"><span class="pre">tasks.py</span></tt> modules
for the applications listed in <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt>. If you want to do something
special you can create your own loader to do what you want.</p>
<p>The entity responsible for registering your task in the registry is a
meta class, <a title="celery.task.base.TaskType" class="reference external" href="../reference/celery.task.base.html#celery.task.base.TaskType"><tt class="xref docutils literal"><span class="pre">TaskType</span></tt></a>. This is the default meta class for
<tt class="docutils literal"><span class="pre">Task</span></tt>. If you want to register your task manually you can set the
<tt class="docutils literal"><span class="pre">abstract</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>This way the task won&#8217;t be registered, but any task subclassing it will.</p>
<p>When tasks are sent, we don&#8217;t send the function code, just the name
of the task. When the worker receives the message it can just look it up in
the task registry to find the execution code.</p>
<p>This means that your workers should always be updated with the same software
as the client. This is a drawback, but the alternative is a technical
challenge that has yet to be solved.</p>
</div>
<div class="section" id="performance-and-strategies">
<h2>Performance and Strategies<a class="headerlink" href="#performance-and-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="granularity">
<h3>Granularity<a class="headerlink" href="#granularity" title="Permalink to this headline">¶</a></h3>
<p>The task&#8217;s granularity is the degree of parallelization your task have.
It&#8217;s better to have many small tasks, than a few long running ones.</p>
<p>With smaller tasks, you can process more tasks in parallel and the tasks
won&#8217;t run long enough to block the worker from processing other waiting tasks.</p>
<p>However, there&#8217;s a limit. Sending messages takes processing power and bandwidth. If
your tasks are so short the overhead of passing them around is worse than
just executing them in-line, you should reconsider your strategy. There is no
universal answer here.</p>
</div>
<div class="section" id="data-locality">
<h3>Data locality<a class="headerlink" href="#data-locality" title="Permalink to this headline">¶</a></h3>
<p>The worker processing the task should be as close to the data as
possible. The best would be to have a copy in memory, the worst being a
full transfer from another continent.</p>
<p>If the data is far away, you could try to run another worker at location, or
if that&#8217;s not possible, cache often used data, or preload data you know
is going to be used.</p>
<p>The easiest way to share data between workers is to use a distributed caching
system, like <a class="reference external" href="http://memcached.org/">memcached</a>.</p>
<p>For more information about data-locality, please read
<a class="reference external" href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">http://research.microsoft.com/pubs/70001/tr-2003-24.pdf</a></p>
</div>
<div class="section" id="state">
<h3>State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p>Since celery is a distributed system, you can&#8217;t know in which process, or even
on what machine the task will run. Indeed you can&#8217;t even know if the task will
run in a timely manner, so please be wary of the state you pass on to tasks.</p>
<p>One gotcha is Django model objects. They shouldn&#8217;t be passed on as arguments
to task classes, it&#8217;s almost always better to re-fetch the object from the
database instead, as there are possible race conditions involved.</p>
<p>Imagine the following scenario where you have an article and a task
that automatically expands some abbreviations in it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;MyCorp&quot;</span><span class="p">,</span> <span class="s">&quot;My Corporation&quot;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>First, an author creates an article and saves it, then the author
clicks on a button that initiates the abbreviation task.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">model_object</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the queue is very busy, so the task won&#8217;t be run for another 2 minutes,
in the meantime another author makes some changes to the article,
when the task is finally run, the body of the article is reverted to the old
version, because the task had the old body in its argument.</p>
<p>Fixing the race condition is easy, just use the article id instead, and
re-fetch the article in the task body:</p>
<div class="highlight-python"><pre>@task
def expand_abbreviations(article_id)
    article = Article.objects.get(id=article_id)
    article.body.replace("MyCorp", "My Corporation")
    article.save()

&gt;&gt;&gt; expand_abbreviations(article_id)</pre>
</div>
<p>There might even be performance benefits to this approach, as sending large
messages may be expensive.</p>
</div>
</div>
</div>


          </div> 
        </div>
      </div>
    <div class="footer">
    <p>
      &copy; Copyright 2009, Ask Solem.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4.
	</p>
    </div>
      <div class="clearer"></div>
    </div>
	<div id="breadcrumbs">
		<a href="index.html" accesskey="U">User Guide</a><img src="triangle_closed.png" alt="Right arrow">
		<a href="../index.html">Celery v1.0.0 (stable) documentation</a>
		</ul>
	</div>
  </body>
</html>