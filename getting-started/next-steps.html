<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Next Steps &mdash; Celery 2.6.0rc5 documentation</title>
    
    <link rel="stylesheet" href="../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/issuetracker.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.6.0rc5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Celery 2.6.0rc5 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="index.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="First Steps with Celery" href="first-steps-with-celery.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="first-steps-with-celery.html" title="First Steps with Celery"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Celery 2.6.0rc5 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
<div class="deck">

    
        <p class="developmentversion">
        This document is for Celery's development version, which can be
        significantly different from previous releases. Get old docs here:

        <a href="http://docs.celeryproject.org/en/latest/getting-started/next-steps.html">2.5</a>.
        </p>
        

</div>
    <div class="section" id="next-steps">
<span id="id1"></span><h1>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="first-steps-with-celery.html#first-steps"><em>First Steps with Celery</em></a> guide is intentionally minimal.  In this guide
we will demonstrate what Celery offers in more detail, including
how to add Celery support for your application and library.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#using-celery-in-your-application" id="id5">Using Celery in your Application</a></li>
<li><a class="reference internal" href="#calling-tasks" id="id6">Calling Tasks</a></li>
<li><a class="reference internal" href="#canvas-designing-workflows" id="id7"><em>Canvas</em>: Designing Workflows</a></li>
</ul>
</div>
<div class="section" id="using-celery-in-your-application">
<h2><a class="toc-backref" href="#id5">Using Celery in your Application</a><a class="headerlink" href="#using-celery-in-your-application" title="Permalink to this headline">¶</a></h2>
<div class="section" id="our-project">
<span id="project-layout"></span><h3>Our Project<a class="headerlink" href="#our-project" title="Permalink to this headline">¶</a></h3>
<p>Project layout:</p>
<div class="highlight-python"><pre>proj/__init__.py
    /celery.py
    /tasks.py</pre>
</div>
<div class="section" id="proj-celery-py">
<h4><tt class="file docutils literal"><span class="pre">proj/celery.py</span></tt><a class="headerlink" href="#proj-celery-py" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s">&#39;amqp://&#39;</span><span class="p">,</span>
                <span class="n">backend</span><span class="o">=</span><span class="s">&#39;amqp://&#39;</span><span class="p">,</span>
                <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;proj.tasks&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>In this module we created our <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><tt class="xref py py-class docutils literal"><span class="pre">Celery</span></tt></a> instance (sometimes
referred to as the <em>app</em>).  To use Celery within your project
you simply import this instance.</p>
<ul>
<li><p class="first">The <tt class="docutils literal"><span class="pre">broker</span></tt> argument specifies the URL of the broker to use.</p>
<blockquote>
<div><p>See <a class="reference internal" href="first-steps-with-celery.html#celerytut-broker"><em>Choosing a Broker</em></a> for more information.</p>
</div></blockquote>
</li>
<li><p class="first">The <tt class="docutils literal"><span class="pre">backend</span></tt> argument specifies the result backend to use,</p>
<blockquote>
<div><p>It&#8217;s used to keep track of task state and results.
While results are disabled by default we use the amqp backend here
to demonstrate how retrieving the results work, you may want to use
a different backend for your application, as they all have different
strenghts and weaknesses.  If you don&#8217;t need results it&#8217;s best
to disable them.  Results can also be disabled for individual tasks
by setting the <tt class="docutils literal"><span class="pre">&#64;task(ignore_result=True)</span></tt> option.</p>
<p>See <a class="reference internal" href="first-steps-with-celery.html#celerytut-keeping-results"><em>Keeping Results</em></a> for more information.</p>
</div></blockquote>
</li>
<li><p class="first">The <tt class="docutils literal"><span class="pre">include</span></tt> argument is a list of modules to import when
the worker starts.  We need to add our tasks module here so
that the worker is able to find our tasks.</p>
</li>
</ul>
</div>
<div class="section" id="proj-tasks-py">
<h4><tt class="file docutils literal"><span class="pre">proj/tasks.py</span></tt><a class="headerlink" href="#proj-tasks-py" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">celery</span>


<span class="nd">@celery.task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="nd">@celery.task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>


<span class="nd">@celery.task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">xsum</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="starting-the-worker">
<h3>Starting the worker<a class="headerlink" href="#starting-the-worker" title="Permalink to this headline">¶</a></h3>
<p>The <strong class="program">celery</strong> program can be used to start the worker:</p>
<div class="highlight-python"><pre>$ celery worker --app=proj -l info</pre>
</div>
<p>When the worker starts you should see a banner and some messages:</p>
<div class="highlight-python"><pre>-------------- celery@halcyon.local v2.6.0rc4
---- **** -----
--- * ***  * -- [Configuration]
-- * - **** --- . broker:      amqp://guest@localhost:5672//
- ** ---------- . app:         __main__:0x1012d8590
- ** ---------- . concurrency: 8 (processes)
- ** ---------- . events:      OFF (enable -E to monitor this worker)
- ** ----------
- *** --- * --- [Queues]
-- ******* ---- . celery:      exchange:celery(direct) binding:celery
--- ***** -----

[2012-06-08 16:23:51,078: WARNING/MainProcess] celery@halcyon.local has started.</pre>
</div>
<p>&#8211; The <em>broker</em> is the URL you specifed in the broker argument in our <tt class="docutils literal"><span class="pre">celery</span></tt>
module, you can also specify a different broker on the command line by using
the <a class="reference internal" href="../reference/celery.bin.base.html#cmdoption-b"><em class="xref std std-option">-b</em></a> option.</p>
<p>&#8211; <em>Concurrency</em> is the number of multiprocessing worker process used
to process your tasks concurrently, when all of these are busy doing work
new tasks will have to wait for one of the tasks to finish before
it can be processed.</p>
<p>The default concurrency number is the number of CPU&#8217;s on that machine
(including cores), you can specify a custom number using <em class="xref std std-option">-c</em> option.
There is no recommended value, as the optimal number depends on a number of
factors, but if your tasks are mostly I/O-bound then you can try to increase
it, experimentation has shown that adding more than twice the number
of CPU&#8217;s is rarely effective, and likely to degrade performance
instead.</p>
<p>Including the default multiprocessing pool, Celery also supports using
Eventlet, Gevent, and threads (see <a class="reference internal" href="../userguide/concurrency/index.html#concurrency"><em>Concurrency</em></a>).</p>
<p>&#8211; <em>Events</em> is an option that when enabled causes Celery to send
monitoring messages (events) for actions occurring in the worker.
These can be used by monitor programs like <tt class="docutils literal"><span class="pre">celery</span> <span class="pre">events</span></tt>,
celerymon and the Django-Celery admin monitor that you can read
about in the <a class="reference internal" href="../userguide/monitoring.html#guide-monitoring"><em>Monitoring and Management guide</em></a>.</p>
<p>&#8211; <em>Queues</em> is the list of queues that the worker will consume
tasks from.  The worker can be told to consume from several queues
at once, and this is used to route messages to specific workers
as a means for Quality of Service, separation of concerns,
and emulating priorities, all described in the <a class="reference internal" href="../userguide/routing.html#guide-routing"><em>Routing Guide</em></a>.</p>
<p>You can get a complete list of command line arguments
by passing in the <cite>&#8211;help</cite> flag:</p>
<div class="highlight-python"><pre>$ celery worker --help</pre>
</div>
<p>These options are described in more detailed in the <a class="reference internal" href="../userguide/workers.html#guide-workers"><em>Workers Guide</em></a>.</p>
<div class="section" id="about-the-app-argument">
<span id="app-argument"></span><h4>About the <em class="xref std std-option">--app</em> argument<a class="headerlink" href="#about-the-app-argument" title="Permalink to this headline">¶</a></h4>
<p>The <em class="xref std std-option">--app</em> argument specifies the Celery app instance to use,
it must be in the form of <tt class="docutils literal"><span class="pre">module.path:celery</span></tt>, where the part before the colon
is the name of the module, and the attribute name comes last.
If a package name is specified instead it will automatically
try to find a <tt class="docutils literal"><span class="pre">celery</span></tt> module in that package, and if the name
is a module it will try to find a <tt class="docutils literal"><span class="pre">celery</span></tt> attribute in that module.
This means that these are all equal:</p>
<blockquote>
<div>$ celery &#8211;app=proj
$ celery &#8211;app=proj.celery:
$ celery &#8211;app=proj.celery:celery</div></blockquote>
</div>
</div>
</div>
<div class="section" id="calling-tasks">
<span id="id2"></span><h2><a class="toc-backref" href="#id6">Calling Tasks</a><a class="headerlink" href="#calling-tasks" title="Permalink to this headline">¶</a></h2>
<p>You can call a task using the <tt class="xref py py-meth docutils literal"><span class="pre">delay()</span></tt> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This method is actually a star-argument shortcut to another method called
<tt class="xref py py-meth docutils literal"><span class="pre">apply_async()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>The latter enables you to specify execution options like the time to run
(countdown), the queue it should be sent to and so on:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">queue</span><span class="o">=</span><span class="s">&#39;lopri&#39;</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above example the task will be sent to a queue named <tt class="docutils literal"><span class="pre">lopri</span></tt> and the
task will execute, at the earliest, 10 seconds after the message was sent.</p>
<p>Applying the task directly will execute the task in the current process,
so that no message is sent:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">4</span>
</pre></div>
</div>
<p>These three methods - <tt class="xref py py-meth docutils literal"><span class="pre">delay()</span></tt>, <tt class="xref py py-meth docutils literal"><span class="pre">apply_async()</span></tt>, and applying
(<tt class="docutils literal"><span class="pre">__call__</span></tt>), represents the Celery calling API, which are also used for
subtasks.</p>
<p>A more detailed overview of the Calling API can be found in the
<a class="reference internal" href="../userguide/calling.html#guide-calling"><em>Calling User Guide</em></a>.</p>
<p>Every task invocation will be given a unique identifier (an UUID), this
is the task id.</p>
<p>The <tt class="docutils literal"><span class="pre">delay</span></tt> and <tt class="docutils literal"><span class="pre">apply_async</span></tt> methods return an <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><tt class="xref py py-class docutils literal"><span class="pre">AsyncResult</span></tt></a>
instance, which can be used to keep track of the tasks execution state.
But for this you need to enable a <em class="xref std std-ref">result backend</em> so that
the state can be stored somewhere.</p>
<p>Results are disabled by default because of the fact that there is no result
backend that suits every application, so to choose one you need to consider
the drawbacks of each individual backend.  For many tasks
keeping the return value isn&#8217;t even very useful, so it&#8217;s a sensible default to
have.  Also note that result backends are not used for monitoring tasks and workers,
for that we use dedicated event messages (see <a class="reference internal" href="../userguide/monitoring.html#guide-monitoring"><em>Monitoring and Management Guide</em></a>).</p>
<p>If you have a result backend configured we can retrieve the return
value of a task:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">4</span>
</pre></div>
</div>
<p>You can find the task&#8217;s id by looking at the <tt class="xref py py-attr docutils literal"><span class="pre">id</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">id</span>
<span class="go">d6b3aea2-fb9b-4ebc-8da4-848818db9114</span>
</pre></div>
</div>
<p>We can also inspect the exception and traceback if the task raised an
exception, in fact <tt class="docutils literal"><span class="pre">result.get()</span></tt> will propagate any errors by default:</p>
<div class="highlight-python"><pre>&gt;&gt;&gt; res = add.delay(2)
&gt;&gt;&gt; res.get(timeout=1)
Traceback (most recent call last):
File "&lt;stdin&gt;", line 1, in &lt;module&gt;
File "/opt/devel/celery/celery/result.py", line 113, in get
    interval=interval)
File "/opt/devel/celery/celery/backends/amqp.py", line 138, in wait_for
    raise self.exception_to_python(meta['result'])
TypeError: add() takes exactly 2 arguments (1 given)</pre>
</div>
<p>If you don&#8217;t wish for the errors to propagate then you can disable that
by passing the <tt class="docutils literal"><span class="pre">propagate</span></tt> argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">propagate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="go">TypeError(&#39;add() takes exactly 2 arguments (1 given)&#39;,)</span>
</pre></div>
</div>
<p>In this case it will return the exception instance raised instead,
and so to check whether the task succeeded or failed you will have to
use the corresponding methods on the result instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">failed</span><span class="p">()</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">successful</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>So how does it know if the task has failed or not?  It can find out by looking
at the tasks <em>state</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">state</span>
<span class="go">&#39;FAILURE&#39;</span>
</pre></div>
</div>
<p>A task can only be in a single state, but it can progress through several
states. The stages of a typical task can be:</p>
<div class="highlight-python"><pre>PENDING -&gt; STARTED -&gt; SUCCESS</pre>
</div>
<p>The started state is a special state that is only recorded if the
<a class="reference internal" href="../configuration.html#std:setting-CELERY_TRACK_STARTED"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_TRACK_STARTED</span></tt></a> setting is enabled, or if the
<tt class="docutils literal"><span class="pre">&#64;task(track_started=True)</span></tt> option is set for the task.</p>
<p>The pending state is actually not a recorded state, but rather
the default state for any task id that is unknown, which you can see
from this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">celery</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="s">&#39;this-id-does-not-exist&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">state</span>
<span class="go">&#39;PENDING&#39;</span>
</pre></div>
</div>
<p>If the task is retried the stages can become even more complex,
e.g, for a task that is retried two times the stages would be:</p>
<div class="highlight-python"><pre>PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS</pre>
</div>
<p>To read more about task states you should see the <a class="reference internal" href="../userguide/tasks.html#task-states"><em>States</em></a> section
in the tasks user guide.</p>
</div>
<div class="section" id="canvas-designing-workflows">
<span id="designing-workflows"></span><h2><a class="toc-backref" href="#id7"><em>Canvas</em>: Designing Workflows</a><a class="headerlink" href="#canvas-designing-workflows" title="Permalink to this headline">¶</a></h2>
<p>We just learned how to call a task using the tasks <tt class="docutils literal"><span class="pre">delay</span></tt> method,
and this is often all you need, but sometimes you may want to pass the
signature of a task invocation to another process or as an argument to another
function, for this Celery uses something called <em>subtasks</em>.</p>
<p>A subtask wraps the arguments and execution options of a single task
invocation in a way such that it can be passed to functions or even serialized
and sent across the wire.</p>
<p>You can create a subtask for the <tt class="docutils literal"><span class="pre">add</span></tt> task using the arguments <tt class="docutils literal"><span class="pre">(2,</span> <span class="pre">2)</span></tt>,
and a countdown of 10 seconds like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">subtask</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<p>There is also a shortcut using star arguments:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<p>and it also supports keyword arguments:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="go">tasks.add(2, 2, debug=True)</span>
</pre></div>
</div>
<p>From any subtask instance we can inspect the different fields:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">subtask</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">{</span><span class="s">&#39;debug&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">args</span>
<span class="go">(2, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">kwargs</span>
<span class="go">{&#39;debug&#39;: True}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;countdown&#39;: 10}</span>
</pre></div>
</div>
<div class="section" id="and-there-s-that-calling-api-again">
<h3>And there&#8217;s that calling API again...<a class="headerlink" href="#and-there-s-that-calling-api-again" title="Permalink to this headline">¶</a></h3>
<p>Subtask instances also support the calling API, which means you can use
<tt class="docutils literal"><span class="pre">delay</span></tt>, <tt class="docutils literal"><span class="pre">apply_async</span></tt>, or <em>calling</em> it directly.</p>
<p>But there is a difference in that the subtask may already have
an argument signature specified.  The <tt class="docutils literal"><span class="pre">add</span></tt> task takes two arguments,
so a subtask specifying two arguments would make a complete signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>But, you can also make incomplete signatures to create what we call
<em>partials</em>:</p>
<div class="highlight-python"><pre># incomplete partial:  add(?, 2)
&gt;&gt;&gt; s2 = add.s(2)</pre>
</div>
<p><tt class="docutils literal"><span class="pre">s2</span></tt> is now a partial subtask that needs another argument to be complete,
and this can actually be resolved when calling the subtask:</p>
<div class="highlight-python"><pre># resolves the partial: add(8, 2)
&gt;&gt;&gt; res = s2.delay(8)
&gt;&gt;&gt; res.get()
10</pre>
</div>
<p>Here we added the argument 8, which was prepended to the existing argument 2
forming a complete signature of <tt class="docutils literal"><span class="pre">add(8,</span> <span class="pre">2)</span></tt>.</p>
<p>Keyword arguments can also be added later, these are then merged with any
existing keyword arguments, but with new arguments taking precedence:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>   <span class="c"># debug is now False.</span>
</pre></div>
</div>
<p>As stated subtasks supports the calling API, and with the introduction
of partial arguments, which means that:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">subtask.apply_async(args=(),</span> <span class="pre">kwargs={},</span> <span class="pre">**options)</span></tt></p>
<blockquote>
<div><p>Calls the subtask with optional partial arguments and partial
keyword arguments.  Also supports partial execution options.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">subtask.delay(*args,</span> <span class="pre">**kwargs)</span></tt></p>
<p>Star argument version of <tt class="docutils literal"><span class="pre">apply_async</span></tt>.  Any arguments will be prepended
to the arguments in the signature, and keyword arguments is merged with any
existing keys.</p>
</li>
</ul>
<p>So this all seems very useful, but what can we actually do with these?
To get to that we must introduce the canvas primitives...</p>
</div>
<div class="section" id="the-primitives">
<h3>The Primitives<a class="headerlink" href="#the-primitives" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">group</span></tt></p>
<blockquote>
<div><p>The group primitive is a subtask that takes a list of tasks that should
be applied in parallel.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">chain</span></tt></p>
<blockquote>
<div><p>The chain primitive lets us link together subtasks so that one is called
after the other, essentially forming a <em>chain</em> of callbacks.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">chord</span></tt></p>
<blockquote>
<div><p>A chord is just like a group but with a callback.  A group consists
of a header group and a body,  where the body is a task that should execute
after all of the tasks in the header is complete.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">map</span></tt></p>
<blockquote>
<div><p>The map primitive works like the built-in <tt class="docutils literal"><span class="pre">map</span></tt> function, but creates
a temporary task where a list of arguments is applied to the task.
E.g. <tt class="docutils literal"><span class="pre">task.map([1,</span> <span class="pre">2])</span></tt> results in a single task
being called, appyling the arguments in order to the task function so
that the result is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">task</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">starmap</span></tt></p>
<blockquote>
<div><p>Works exactly like map except the arguments are applied as <tt class="docutils literal"><span class="pre">*args</span></tt>.
For example <tt class="docutils literal"><span class="pre">add.starmap([(2,</span> <span class="pre">2),</span> <span class="pre">(4,</span> <span class="pre">4)])</span></tt> results in a single
task calling:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">chunks</span></tt></p>
<blockquote>
<div><p>Chunking splits a long list of arguments into parts, e.g the operation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>will create 10 tasks that apply 100 items each.</p>
</div></blockquote>
</li>
</ul>
<p>The primitives are also subtasks themselves, so that they can be combined
in any number of ways to compose complex workflows.</p>
<p>Here&#8217;s some examples:</p>
<div class="highlight-python"><pre>- Simple chain</pre>
</div>
<blockquote>
<div><p>Here&#8217;s a simple chain, the first task executes passing its return value
to the next task in the chain, and so on.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># 2 + 2 + 4 + 8</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="mi">16</span>
</pre></div>
</div>
<p>This can also be written using pipes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">Immutable subtasks</p>
<blockquote>
<div><p>As we have learned signatures can be partial, so that arguments can be
added to the existing arguments, but you may not always want that,
for example if you don&#8217;t want the result of the previous task in a chain.</p>
<p>In that case you can mark the subtask as immutable, so that the arguments
cannot be changed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">subtask</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">immutable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>There&#8217;s also an <tt class="docutils literal"><span class="pre">.si</span></tt> shortcut for this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can create a chain of independent tasks instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Simple group</p>
<blockquote>
<div><p>We can easily create a group of tasks to execute in parallel:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
<ul>
<li><p class="first">For primitives <cite>.apply_async</cite> is special...</p>
<blockquote>
<div><p>as it will create a temporary task to apply the tasks in,
for example by <em>applying the group</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="p">()</span>  <span class="c"># &lt;&lt; applying</span>
</pre></div>
</div>
<p>the act of sending the messages for the tasks in the group
will happen in the current process,
but with <tt class="docutils literal"><span class="pre">.apply_async</span></tt> this happens in a temporary task
instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>This is useful because we can e.g. specify a time for the
messages in the group to be called:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Simple chord</p>
<blockquote>
<div><p>The chord primitive enables us to add callback to be called when
all of the tasks in a group has finished executing, which is often
required for algorithms that aren&#8217;t embarrassingly parallel:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>The above example creates 10 task that all start in parallel,
and when all of them is complete the return values is combined
into a list and sent to the <tt class="docutils literal"><span class="pre">xsum</span></tt> task.</p>
<p>The body of a chord can also be immutable, so that the return value
of the group is not passed on to the callback:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">((</span><span class="n">import_contact</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">),</span>
<span class="gp">... </span>      <span class="n">notify_complete</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">import_id</span><span class="p">))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>Note the use of <tt class="docutils literal"><span class="pre">.si</span></tt> above which creates an immutable subtask.</p>
</div></blockquote>
</li>
<li><p class="first">Blow your mind by combining</p>
<blockquote>
<div><p>Chains can be partial too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

<span class="go"># (16 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">160</span>
</pre></div>
</div>
<p>Which means that you can combine chains too:</p>
<div class="highlight-python"><pre># ((4 + 16) * 2 + 4) * 8
&gt;&gt;&gt; c2 = (add.s(4, 16) | mul.s(2) | (add.s(4) | mul.s(8)))
&gt;&gt;&gt; c2
tasks.add(16) | tasks.mul(2) | tasks.add(4) | tasks.mul(8)

&gt;&gt;&gt; res = c2()
&gt;&gt;&gt; res.get()
352</pre>
</div>
<p>Chaining a group together with another task will automatically
upgrade it to be a chord:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c3</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>Groups and chords accepts partial arguments too, so in a chain
the return value of the previous task is forwarded to all tasks in the group:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">new_user_workflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">create_user</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span>
<span class="gp">... </span>                     <span class="n">import_contacts</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span>
<span class="gp">... </span>                     <span class="n">send_welcome_email</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span>
<span class="gp">... </span><span class="n">new_user_workflow</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;artv&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">first</span><span class="o">=</span><span class="s">&#39;Art&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">last</span><span class="o">=</span><span class="s">&#39;Vandelay&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">email</span><span class="o">=</span><span class="s">&#39;art@vandelay.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Be sure to read more about workflows in the <a class="reference internal" href="../userguide/canvas.html#guide-canvas"><em>Canvas</em></a> user
guide.</p>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>This document is incomplete - and ends here :(*</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="http://cloud.github.com/downloads/celery/celery/celery_128.png" alt="Logo"/>
</a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="first-steps-with-celery.html"
                        title="previous chapter">First Steps with Celery</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="resources.html"
                        title="next chapter">Resources</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/getting-started/next-steps.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             >next</a> |</li>
        <li class="right" >
          <a href="first-steps-with-celery.html" title="First Steps with Celery"
             >previous</a> |</li>
        <li><a href="../index.html">Celery 2.6.0rc5 documentation</a> &raquo;</li>
          <li><a href="index.html" >Getting Started</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2009-2012, Ask Solem &amp; Contributors.
    </div>
  </body>
</html>